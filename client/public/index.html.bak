<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>minzoAI Dashboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.7.1/gsap.min.js"></script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Inter', sans-serif;
    }

    /* Mobile-friendly viewport height handling: use --vh to avoid browser UI issues */
    :root {
        --vh: 1vh;
    }

    html, body {
        height: 100%;
    }

    body {
        background: #121212;
        color: #ffffff;
        display: flex;
        height: calc(var(--vh, 1vh) * 100);
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        touch-action: manipulation;
        transition: all 0.5s ease;
    }

    body.light-mode {
        background: #f5f5f7;
        color: #333333;
    }

    /* LEFT SIDEBAR */
    .sidebar {
        width: 260px;
        background: #1a1a1a;
        padding: 20px;
        border-right: 1px solid #2a2a2a;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        z-index: 10;
        position: relative;
        transition: transform 0.3s ease;
    }

    .light-mode .sidebar {
        background: #ffffff;
        border-right: 1px solid #e0e0e0;
    }

    .sidebar.collapsed {
        transform: translateX(-100%);
        width: 0;
        padding: 0;
    }

    .chats-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .chat-list-item {
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        transition: background 0.2s ease, transform 0.08s ease;
    }

    .chat-list-item:hover {
        background: rgba(255,255,255,0.03);
        transform: translateY(-1px);
    }

    .sidebar-toggle {
        position: fixed;
        top: 1rem;
        left: 1rem;
        z-index: 20;
        background: rgba(0, 0, 0, 0.5);
        border: none;
        border-radius: 8px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        backdrop-filter: blur(10px);
    }

    .light-mode .sidebar-toggle {
        background: rgba(255, 255, 255, 0.7);
        color: #333;
    }

    .sidebar h3 {
        color: #cfcfcf;
        font-size: 15px;
        margin: 20px 0 10px;
        opacity: 0.8;
    }

    .light-mode .sidebar h3 {
        color: #666;
    }

    .nav-item {
        padding: 10px;
        color: #ddd;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 4px;
        transition: 0.2s;
    }

    .light-mode .nav-item {
        color: #555;
    }

    .nav-item:hover {
        background: #2c2c2c;
    }

    .light-mode .nav-item:hover {
        background: #f0f0f0;
    }

    /* MAIN CONTENT */
    .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        text-align: center;
        padding: 0;
        position: relative;
        overflow: visible;
        width: 100%;
    }

    .main.chat-mode {
        justify-content: flex-start;
        padding-bottom: 2rem;
        display: flex;
        flex-direction: column;
        align-items: stretch;
    }

    .main.empty-state {
        justify-content: center;
        padding: 40px;
    }

    /* Welcome text styling */
    .main.empty-state .title {
        animation: fadeInUp 0.6s ease-out;
    }

    .main.empty-state .search-box {
        animation: slideUpFade 0.6s ease-out 0.1s both;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideUpFade {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .title {
        font-size: 28px;
        font-weight: 500;
        margin-bottom: 40px;
        color: #e6e6e6;
        z-index: 10;
        position: relative;
        padding-top: 40px;
    }

    .light-mode .title {
        color: #333;
    }

    .title.hidden {
        display: none;
    }

    /* SEARCH BAR */
    .search-box {
        width: 60%;
        background: #1e1e1e;
        border-radius: 50px;
        display: flex;
        align-items: center;
        padding: 14px 22px;
        border: 1px solid #2a2a2a;
        transition: all 0.3s ease;
        z-index: 10;
        position: relative;
        margin-top: 20px;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .search-box:focus-within {
        border-color: rgba(100, 200, 255, 0.6);
        box-shadow: 0 4px 20px rgba(100, 200, 255, 0.3);
    }

    .search-box.compact {
        position: fixed;
        top: 1rem;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        max-width: 800px;
        margin: 0;
        background: rgba(30, 30, 30, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .light-mode .search-box {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .light-mode .search-box:focus-within {
        border-color: rgba(100, 150, 255, 0.6);
        box-shadow: 0 4px 20px rgba(100, 150, 255, 0.2);
    }

    .light-mode .search-box {
        background: #ffffff;
        border: 1px solid #e0e0e0;
    }

    .search-box:hover {
        border-color: #3d3d3d;
    }

    .light-mode .search-box:hover {
        border-color: #b0b0b0;
    }

    .search-box input {
        flex: 1;
        background: transparent;
        outline: none;
        border: none;
        color: #fff;
        font-size: 16px;
    }

    .light-mode .search-box input {
        color: #333;
    }

    .icons {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 20px;
        cursor: pointer;
    }

    .icons div:hover {
        opacity: 0.6;
    }

    /* CHAT CONTAINER */
    .chat-container {
        width: 100%;
        max-width: 1100px;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        overflow-x: hidden;
        /* reduce top padding so messages appear higher and increase bottom padding for space */
        padding: 4rem 1rem 12rem 1rem;
        z-index: 8;
        margin: 0 auto;
        flex: 1;
        position: relative;
    }

    .chat-container::-webkit-scrollbar {
        width: 8px;
    }

    .chat-container::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .light-mode .chat-container::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
    }

    .light-mode .chat-container::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
    }

    /* MESSAGE WRAPPER */
    .message-wrapper {
        display: flex;
        margin-bottom: 1.75rem;
        gap: 0.75rem;
        animation: slideIn 0.3s ease;
        width: 100%;
        min-height: 40px;
        align-items: flex-start;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-wrapper.user {
        justify-content: flex-end;
        padding-right: 1rem;
    }

    .message-wrapper.assistant {
        justify-content: flex-start;
        padding-left: 1rem;
    }

    /* AVATAR */
    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
        margin-top: 0.25rem;
    }

    .message-wrapper.user .message-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        order: 2;
    }

    .message-wrapper.assistant .message-avatar {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    /* MESSAGE CONTENT */
    .message-content {
        /* allow assistant messages to take more horizontal space for a larger panel */
        max-width: 80%;
        word-wrap: break-word;
        line-height: 1.6;
        display: flex;
        flex-direction: column;
        width: auto;
    }

    @media (max-width: 768px) {
        .message-content {
            max-width: 85%;
        }
    }

    .message-text {
        /* bigger, taller result panel */
        padding: 1.25rem 1.5rem;
        border-radius: 18px;
        font-size: 16px;
        background: rgba(0, 0, 0, 0.44);
        color: #e6e6e6;
        backdrop-filter: blur(10px);
        word-wrap: break-word;
        white-space: pre-wrap;
        line-height: 1.7;
        min-height: 160px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    }

    .light-mode .message-text {
        background: rgba(0, 0, 0, 0.08);
        color: #333;
    }

    .message-wrapper.user .message-text {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
        color: #ffffff;
        border-bottom-right-radius: 4px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .message-wrapper.assistant .message-text {
        background: rgba(255, 255, 255, 0.1);
        color: #e6e6e6;
        border-bottom-left-radius: 4px;
        border-left: 3px solid rgba(100, 200, 255, 0.5);
    }

    .light-mode .message-wrapper.assistant .message-text {
        background: rgba(0, 0, 0, 0.06);
        color: #333;
        border-left: 3px solid rgba(100, 150, 255, 0.6);
    }

    /* Formatted content in messages */
    .message-text strong {
        color: #64c8ff;
        font-weight: 600;
    }

    /* Voice button SVG sizing */
    .input-icons #voiceBtn svg {
        width: 22px;
        height: 22px;
        display: inline-block;
        vertical-align: middle;
        fill: currentColor;
    }

    /* Flaticon attribution small label */
    .flaticon-attribution {
        position: fixed;
        left: 12px;
        bottom: 8px;
        font-size: 11px;
        color: rgba(255,255,255,0.75);
        background: rgba(0,0,0,0.25);
        padding: 6px 8px;
        border-radius: 6px;
        z-index: 9999;
        backdrop-filter: blur(4px);
    }

    .light-mode .message-text strong {
        color: #0066cc;
    }

    .message-text em {
        color: rgba(255, 255, 255, 0.8);
        font-style: italic;
    }

    .message-text code {
        background: rgba(0, 0, 0, 0.4);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        color: #64c8ff;
    }

    .message-text ul, .message-text ol {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
    }

    .message-text li {
        margin: 0.25rem 0;
    }

    /* Sources and metadata */
    .message-metadata {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.5);
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .light-mode .message-metadata {
        color: rgba(0, 0, 0, 0.5);
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .metadata-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* Confidence badge */
    .confidence-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        background: rgba(100, 200, 100, 0.3);
        color: #64c864;
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }

    /* TYPING INDICATOR */
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 0.875rem 1.25rem;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        animation: typing 1.4s infinite;
    }

    .light-mode .typing-dot {
        background: rgba(0, 0, 0, 0.6);
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% {
            opacity: 0.5;
            transform: translateY(0);
        }
        30% {
            opacity: 1;
            transform: translateY(-10px);
        }
    }

    /* SEARCH RESULT (deprecated, kept for compatibility) */
    .search-result {
        display: none;
    }

    /* 3D CANVAS */
    #container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
    }

    /* HEADER */
    .header {
        position: fixed;
        top: 2rem;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        z-index: 10;
        mix-blend-mode: difference;
    }

    .header h1 {
        font-size: 3.5rem;
        font-weight: 900;
        line-height: 1;
        text-transform: uppercase;
        background: linear-gradient(45deg, #ff6e7f, #bfe9ff);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        opacity: 0.9;
        letter-spacing: -1px;
        filter: drop-shadow(0 0 15px rgba(255,255,255,0.3));
    }

    .light-mode .header h1 {
        background: linear-gradient(45deg, #8b5cf6, #06b6d4);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    /* COLOR CONTROLS */
    .color-controls {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 10;
        background: rgba(0, 0, 0, 0.3);
        padding: 1rem;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        transition: transform 0.28s ease, opacity 0.28s ease;
    }

    .color-controls.collapsed {
        transform: translateX(120%);
        opacity: 0;
        pointer-events: none;
    }

    /* Small toggle button to show/hide color-controls */
    .color-controls-toggle {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 11;
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background: rgba(0,0,0,0.45);
        color: #fff;
        border: none;
        box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }

    .light-mode .color-controls-toggle {
        background: rgba(255,255,255,0.85);
        color: #222;
        border: 1px solid rgba(0,0,0,0.06);
    }

    /* THEME TOGGLE */
    .theme-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .theme-toggle button {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.12);
        color: white;
        padding: 0.45rem 0.75rem;
        border-radius: 999px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .light-mode .theme-toggle button {
        background: rgba(0,0,0,0.04);
        border: 1px solid rgba(0,0,0,0.08);
        color: #333;
    }

    .theme-toggle button.active {
        box-shadow: 0 6px 18px rgba(0,0,0,0.25);
        transform: translateY(-1px);
    }

    .panel-controls {
        margin-top: 0.75rem;
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }

    .panel-controls button {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.12);
        color: #fff;
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .light-mode .panel-controls button {
        background: rgba(0,0,0,0.04);
        border: 1px solid rgba(0,0,0,0.08);
        color: #333;
    }

    /* Compact switch */
    .switch {
        display: inline-block;
        position: relative;
        width: 72px;
        height: 34px;
    }

    .switch input {
        display: none;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background: rgba(255,255,255,0.06);
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.12);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 8px;
        transition: background 0.25s ease, border-color 0.25s ease;
    }

    .slider .icon { font-size: 14px; pointer-events: none; }

    .switch .slider::after {
        content: '';
        position: absolute;
        width: 28px;
        height: 28px;
        left: 3px;
        top: 3px;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        transition: transform 0.25s ease, background 0.25s ease;
    }

    .switch input:checked + .slider {
        background: rgba(0,0,0,0.08);
        border-color: rgba(0,0,0,0.12);
    }

    .switch input:checked + .slider::after {
        transform: translateX(38px);
        background: #111;
    }

    .light-mode .switch .slider {
        background: rgba(0,0,0,0.04);
        border: 1px solid rgba(0,0,0,0.08);
    }

    .light-mode .switch input:checked + .slider::after {
        background: #fff;
    }

    .light-mode .color-controls {
        background: rgba(255, 255, 255, 0.7);
    }

    .color-scheme {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .color-scheme button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        min-width: 120px;
    }

    .light-mode .color-scheme button {
        background: rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.1);
        color: #333;
    }

    .color-scheme button:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .light-mode .color-scheme button:hover {
        background: rgba(0, 0, 0, 0.1);
    }

    .color-scheme button.active {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .light-mode .color-scheme button.active {
        background: rgba(0, 0, 0, 0.15);
        border-color: rgba(0, 0, 0, 0.3);
    }

    .color-preview {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .light-mode .color-preview {
        border: 2px solid rgba(0, 0, 0, 0.2);
    }

    .color-preview.cosmic {
        background: linear-gradient(45deg, #ff6e7f, #bfe9ff);
    }

    .color-preview.neon {
        background: linear-gradient(45deg, #00ff87, #60efff);
    }

    .color-preview.sunset {
        background: linear-gradient(45deg, #ff8c37, #ff427a);
    }

    .color-preview.ocean {
        background: linear-gradient(45deg, #0082c8, #00b4db);
    }

    /* FOOTER */
    .footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding: 1rem 2rem;
        text-align: center;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        transition: all 0.3s ease;
        z-index: 12;
    }

    .light-mode .footer {
        background: rgba(255, 255, 255, 0.4);
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        color: rgba(0, 0, 0, 0.6);
    }

    .footer a {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .light-mode .footer a {
        color: rgba(0, 0, 0, 0.8);
    }

    .footer a:hover {
        color: rgba(255, 255, 255, 1);
        text-shadow: 0 0 10px rgba(255, 100, 200, 0.5);
    }

    .light-mode .footer a:hover {
        color: rgba(0, 0, 0, 1);
        text-shadow: 0 0 10px rgba(100, 150, 255, 0.3);
    }

    .footer-divider {
        margin: 0 0.5rem;
        opacity: 0.4;
    }

    /* CONTROLS */
    .controls {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 1rem;
        z-index: 10;
        background: rgba(0, 0, 0, 0.3);
        padding: 1rem;
        border-radius: 50px;
        backdrop-filter: blur(10px);
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }

    

    
    .light-mode .controls button {
        background: rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.1);
        color: #333;
    }



    .light-mode .controls button:hover {
        background: rgba(0, 0, 0, 0.1);
    }


    /* INPUT CONTAINER */
    .input-container {
        position: fixed;
        /* respect safe area inset on iOS (notch / home indicator) */
        bottom: calc(env(safe-area-inset-bottom, 0px) + 4.5rem);
        left: 50%;
        transform: translateX(-50%);
        z-index: 15;
        width: 90%;
        max-width: 600px;
        padding: 0 1rem;
        display: flex;
        gap: 0.75rem;
        align-items: center;
        background: rgba(30, 30, 30, 0.85);
        padding: 1rem;
        border-radius: 24px;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .input-container input {
        flex: 1;
        padding: 0.875rem 1.25rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(30, 30, 30, 0.8);
        border-radius: 24px;
        color: #fff;
        font-size: 16px; /* prevents iOS zoom on focus */
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        outline: none;
    }

    .input-container input:focus {
        border-color: rgba(100, 200, 255, 0.6);
        background: rgba(30, 30, 30, 0.95);
        box-shadow: 0 0 20px rgba(100, 200, 255, 0.3);
    }

    .input-container input::placeholder {
        color: rgba(255, 255, 255, 0.4);
    }

    .light-mode .input-container {
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .light-mode .input-container input {
        background: rgba(255, 255, 255, 0.9);
        border-color: rgba(0, 0, 0, 0.1);
        color: #333;
    }

    .light-mode .input-container input::placeholder {
        color: rgba(0, 0, 0, 0.4);
    }

    .light-mode .input-container input:focus {
        border-color: rgba(100, 150, 255, 0.6);
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 0 20px rgba(100, 150, 255, 0.2);
    }

    .input-container button {
        width: 40px;
        height: 40px;
        padding: 0;
        background: linear-gradient(135deg, rgba(100, 150, 255, 0.8) 0%, rgba(100, 200, 255, 0.8) 100%);
        border: none;
        border-radius: 50%;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        flex-shrink: 0;
        box-shadow: 0 4px 15px rgba(100, 150, 255, 0.3);
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .input-container button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(100, 150, 255, 0.5);
    }

    .input-container button:active {
        transform: scale(0.95);
    }

    .input-icons {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Apply circular button style to both the voice div and the send button */
    .input-icons div,
    .input-icons button {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        border-radius: 50%;
        transition: all 0.18s ease;
        background: rgba(100, 200, 255, 0.08);
        border: 1px solid rgba(255,255,255,0.04);
        padding: 4px;
        box-sizing: border-box;
        /* icon color (uses SVG fill: currentColor) */
        color: #64c8ff;
        overflow: visible;
    }

    .input-icons div:hover,
    .input-icons button:hover {
        background: rgba(100, 200, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(0,0,0,0.45);
        /* make icon darker on hover for contrast */
        color: #03283a;
    }

    .light-mode .input-icons div,
    .light-mode .input-icons button {
        background: rgba(100, 150, 255, 0.06);
    }

    .light-mode .input-icons div:hover,
    .light-mode .input-icons button:hover {
        background: rgba(100, 150, 255, 0.14);
    }

    /* SVG icon sizing to fit the circular button */
    .input-icons svg {
        width: 12px;
        height: 12px;
        display: block;
        max-width: 100%;
        max-height: 100%;
        fill: currentColor;
    }

 

 

    /* RESPONSIVE DESIGN */
    /* Large tablets and small laptops */
    @media (max-width: 1200px) {
        .sidebar {
            width: 220px;
        }
        
        .search-box {
            width: 70%;
        }
        
        .header h1 {
            font-size: 3rem;
        }
    }

    /* Tablets */
    @media (max-width: 992px) {
        .sidebar {
            width: 200px;
            padding: 15px;
        }
        
        .search-box {
            width: 80%;
            padding: 12px 18px;
        }
        
        .header h1 {
            font-size: 2.5rem;
        }
        
        .color-controls {
            top: 1rem;
            right: 1rem;
        }
        
        .controls {
            bottom: 1.5rem;
        }
        
        .input-container {
            bottom: 1.5rem;
        }
    }

    /* Small tablets and large phones */
    @media (max-width: 768px) {
        body {
            flex-direction: column;
        }
        
        .sidebar {
            width: 100%;
            height: auto;
            max-height: 60vh;
            position: fixed;
            top: 0;
            left: 0;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 100;
            border-right: none;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .light-mode .sidebar {
            border-bottom: 1px solid #e0e0e0;
        }
        
        .sidebar.active {
            transform: translateY(0);
        }
        
        .sidebar.collapsed {
            transform: translateY(-100%);
        }
        
        .sidebar-toggle {
            display: flex;
        }
        
        .main {
            padding: 20px;
            margin-top: 60px;
        }
        
        .title {
            font-size: 24px;
            margin-bottom: 30px;
        }
        
        .search-box {
            width: 90%;
            padding: 10px 16px;
        }
        
        .header {
            top: 1rem;
        }
        
        .header h1 {
            font-size: 2rem;
        }
        
        .color-controls {
            position: static;
            margin: 1rem auto;
            width: 90%;
            max-width: 300px;
        }
        
        .color-scheme {
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .color-scheme button {
            min-width: 100px;
        }
        
        .controls {
            flex-direction: column;
            width: 90%;
            max-width: 300px;
            border-radius: 16px;
        }
        
        .controls button {
            width: 100%;
        }
        
        .input-container {
            width: 95%;
            bottom: 1rem;
            max-width: 100%;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-container input {
            width: 100%;
        }

        .input-icons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            width: 100%;
        }

        .input-icons div,
        .input-container button {
            width: auto;
            flex-shrink: 0;
        }
    }

    /* Mobile phones */
    @media (max-width: 576px) {
        .sidebar {
            max-height: 70vh;
        }
        
        .main {
            padding: 10px;
            margin-top: 50px;
            height: calc(100vh - 130px);
            z-index: 1;
        }
        
        .main.chat-mode {
            overflow: visible;
        }
        
        .title {
            font-size: 20px;
            margin-bottom: 20px;
        }
        
        .chat-container {
            padding: 1rem 0.75rem 6rem 0.75rem;
            height: auto;
            min-height: calc(100vh - 180px);
            overflow-y: scroll;
        }

        .message-wrapper {
            margin-bottom: 1rem;
        }

        .message-content {
            max-width: 90%;
        }

        .message-text {
            padding: 0.75rem 1rem;
            font-size: 14px;
        }

        .message-metadata {
            font-size: 0.75rem;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .input-container {
            width: 95%;
            bottom: 5rem;
            max-width: calc(100vw - 20px);
            padding: 0.75rem;
            gap: 0.5rem;
        }

        .input-container input {
            padding: 0.75rem 1rem;
            font-size: 16px;
            width: 100%;
        }

        .input-icons {
            display: flex;
            gap: 0.4rem;
        }

        .input-icons div,
        .input-container button {
            width: 40px;
            height: 40px;
            font-size: 16px;
            flex-shrink: 0;
        }

        .footer {
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
            bottom: 0;
        }

        .footer div {
            line-height: 1.3;
        }
        
        .header h1 {
            font-size: 1.5rem;
        }
        
        .color-controls {
            padding: 0.75rem;
            top: 1rem;
            right: 1rem;
            width: auto;
            max-width: 250px;
        }
        
        .color-scheme {
            flex-direction: column;
            gap: 0.5rem;
        }

        .color-scheme button {
            min-width: 80px;
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        
        .color-preview {
            width: 16px;
            height: 16px;
        }
        
        .controls {
            padding: 0.75rem;
            gap: 0.75rem;
        }
        
        .controls button {
            padding: 0.7rem 1.2rem;
            font-size: 0.85rem;
            min-width: 100px;
        }
    }

    /* Very small phones */
    @media (max-width: 400px) {
        .sidebar-toggle {
            top: 0.5rem;
            left: 0.5rem;
            width: 35px;
            height: 35px;
        }
        
        .main {
            margin-top: 40px;
            padding: 8px;
            height: calc(100vh - 110px);
            z-index: 1;
        }
        
        .main.chat-mode {
            overflow: visible;
        }
        
        .title {
            font-size: 18px;
            margin-bottom: 15px;
        }

        .chat-container {
            padding: 0.75rem 0.5rem 5.5rem 0.5rem;
            height: auto;
            min-height: calc(100vh - 160px);
            overflow-y: scroll;
        }

        .message-text {
            padding: 0.6rem 0.8rem;
            font-size: 13px;
        }

        .message-metadata {
            font-size: 0.7rem;
        }

        .input-container {
            width: 90%;
            bottom: 4.5rem;
            padding: 0.6rem;
            border-radius: 20px;
        }

        .input-container input {
            padding: 0.7rem 0.9rem;
            font-size: 14px;
            border-radius: 18px;
        }

        .input-icons div,
        .input-container button {
            width: 36px;
            height: 36px;
            font-size: 14px;
            border-radius: 50%;
        }

        .footer {
            padding: 0.6rem 0.75rem;
            font-size: 0.7rem;
        }
        
        .header h1 {
            font-size: 1.3rem;
        }
        
        .color-controls {
            padding: 0.6rem;
            top: 0.8rem;
            right: 0.8rem;
            max-width: 220px;
        }
        
        .color-scheme {
            gap: 0.3rem;
            flex-direction: column;
        }
        
        .color-scheme button {
            min-width: 70px;
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
        }
        
        .controls {
            padding: 0.5rem;
            gap: 0.5rem;
        }
        
        .controls button {
            padding: 0.6rem 1rem;
            font-size: 0.8rem;
        }
    }

    /* Handle landscape orientation on mobile */
    @media (max-height: 500px) and (orientation: landscape) {
        .sidebar {
            max-height: 80vh;
        }
        
        .main {
            margin-top: 40px;
        }
        
        .title {
            margin-bottom: 15px;
        }
        
        .search-box {
            margin-top: 10px;
        }
        
        .controls {
            bottom: 1rem;
        }
        
        .input-container {
            bottom: 1rem;
        }
    }

    /* Floating Auth Modal */
    .auth-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
    }

    .auth-modal-backdrop.open {
        display: flex;
    }

    .auth-modal {
        width: 360px;
        max-width: calc(100% - 32px);
        background: linear-gradient(180deg, rgba(18,18,18,0.96), rgba(28,28,28,0.98));
        border-radius: 12px;
        padding: 18px;
        box-shadow: 0 12px 40px rgba(0,0,0,0.6);
        color: #fff;
        z-index: 210;
        transform: translateY(-10px);
        transition: transform 0.18s ease, opacity 0.18s ease;
    }

    .auth-modal h3 {
        margin-bottom: 8px;
        font-size: 18px;
        color: #e6eef8;
    }

    .auth-modal .fields { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }

    .auth-modal input[type="text"], .auth-modal input[type="email"], .auth-modal input[type="password"] {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.06);
        background: rgba(0,0,0,0.25);
        color: #fff;
        outline: none;
    }

    .auth-modal .actions { display:flex; gap:8px; margin-top:12px; }
    .auth-modal .actions button { flex:1; padding:10px 12px; border-radius:8px; border:none; cursor:pointer; }

    .auth-modal .actions .primary { background: linear-gradient(135deg,#64c8ff,#7ee0ff); color:#033; font-weight:600; }
    .auth-modal .actions .secondary { background: rgba(255,255,255,0.06); color:#fff; }

    .auth-modal .close-btn { position:absolute; top:8px; right:10px; background:transparent; border:none; color:rgba(255,255,255,0.7); font-size:18px; cursor:pointer; }

    .auth-modal .google-btn { background: linear-gradient(90deg,#fff,#f0f4ff); color:#111; border-radius:8px; padding:8px; text-align:center; cursor:pointer; }

    /* Fullscreen result view */
    .fs-result-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 300;
        padding: 5px;
        backdrop-filter: blur(4px);
    }
    .fs-result-backdrop.open { 
        display: flex; 
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .fs-result {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(18,18,18,0.99) 0%, rgba(28,28,28,0.99) 100%);
        border-radius: 8px;
        padding: 40px;
        box-shadow: 0 25px 80px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.1);
        overflow-y: auto;
        color: #fff;
        position: relative;
        border: 1px solid rgba(255,255,255,0.1);
        display: flex;
        flex-direction: column;
        animation: slideUp 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(40px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fs-result::-webkit-scrollbar {
        width: 10px;
    }

    .fs-result::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
    }

    .fs-result::-webkit-scrollbar-thumb {
        background: rgba(100,200,255,0.4);
        border-radius: 10px;
        border: 2px solid rgba(255,255,255,0.05);
    }

    .fs-result::-webkit-scrollbar-thumb:hover {
        background: rgba(100,200,255,0.6);
    }

    .fs-result-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 30px;
        padding-bottom: 24px;
        border-bottom: 2px solid rgba(100,200,255,0.2);
    }

    .fs-result-title-group {
        flex: 1;
    }

    .fs-result h2 { 
        margin: 0 0 8px 0; 
        font-size: 32px;
        font-weight: 700;
        line-height: 1.2;
        color: #fff;
        text-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }

    .fs-result .meta { 
        color: rgba(100,200,255,0.8);
        font-size: 13px;
        margin: 0;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }

    .fs-result .meta-item {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: rgba(100,200,255,0.1);
        border-radius: 6px;
        font-size: 12px;
    }

    .fs-result .close { 
        position: relative;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 8px;
        color: rgba(255,255,255,0.8);
        font-size: 24px;
        cursor: pointer;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .fs-result .close:hover {
        background: rgba(255,100,100,0.2);
        border-color: rgba(255,100,100,0.4);
        color: #ff6b6b;
    }

    .fs-result-content {
        flex: 1;
        overflow-y: auto;
        padding-right: 16px;
    }

    .fs-result .snippet { 
        font-size: 16px;
        line-height: 1.8;
        color: rgba(255,255,255,0.88);
        margin-bottom: 28px;
        padding: 20px;
        background: rgba(100,200,255,0.08);
        border-radius: 10px;
        border-left: 4px solid rgba(100,200,255,0.4);
    }

    .fs-result-section-title {
        font-size: 14px;
        font-weight: 700;
        color: rgba(100,200,255,0.9);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 24px 0 12px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .fs-result .keypoints { 
        margin: 16px 0 24px 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .fs-result .keypoints li { 
        background: linear-gradient(135deg, rgba(100,200,255,0.08) 0%, rgba(100,150,255,0.04) 100%);
        padding: 12px 16px;
        border-radius: 10px;
        list-style: none;
        border: 1px solid rgba(100,200,255,0.15);
        color: rgba(255,255,255,0.9);
        font-size: 14px;
        line-height: 1.5;
        transition: all 0.2s ease;
    }

    .fs-result .keypoints li:hover {
        background: linear-gradient(135deg, rgba(100,200,255,0.12) 0%, rgba(100,150,255,0.08) 100%);
        border-color: rgba(100,200,255,0.25);
        transform: translateX(4px);
    }

    .fs-result .keypoints li::before {
        content: 'âœ¦ ';
        color: rgba(100,200,255,0.7);
        font-weight: 600;
        margin-right: 6px;
    }

    .fs-result .external { 
        margin-top: 28px;
        padding-top: 24px;
        border-top: 1px solid rgba(255,255,255,0.1);
        display: flex;
        gap: 12px;
    }

    .fs-result .external a { 
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #fff;
        background: linear-gradient(135deg, rgba(100,200,255,0.8) 0%, rgba(100,150,255,0.8) 100%);
        text-decoration: none;
        font-weight: 600;
        padding: 10px 20px;
        border-radius: 10px;
        transition: all 0.2s ease;
        font-size: 14px;
    }

    .fs-result .external a:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(100,200,255,0.3);
    }

    .fs-result .external a::after {
        content: 'â†—';
    }

    /* Light mode adjustments */
    .light-mode .fs-result {
        background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(245,245,250,0.98) 100%);
        color: #333;
    }

    .light-mode .fs-result h2 {
        color: #222;
        text-shadow: none;
    }

    .light-mode .fs-result .meta { 
        color: rgba(100,150,255,0.9);
    }

    .light-mode .fs-result .meta-item {
        background: rgba(100,150,255,0.15);
    }

    .light-mode .fs-result .snippet {
        background: rgba(100,150,255,0.08);
        border-left-color: rgba(100,150,255,0.5);
        color: #333;
    }

    .light-mode .fs-result .keypoints li {
        background: linear-gradient(135deg, rgba(100,150,255,0.08) 0%, rgba(100,150,255,0.04) 100%);
        border: 1px solid rgba(100,150,255,0.2);
        color: #333;
    }

    .light-mode .fs-result .keypoints li:hover {
        background: linear-gradient(135deg, rgba(100,150,255,0.12) 0%, rgba(100,150,255,0.08) 100%);
    }

    .light-mode .fs-result .close {
        background: rgba(0,0,0,0.05);
        border-color: rgba(0,0,0,0.1);
        color: rgba(0,0,0,0.6);
    }

    .light-mode .fs-result .close:hover {
        background: rgba(255,100,100,0.1);
    }

    @media (max-width: 768px) {
        .fs-result-backdrop {
            padding: 0px;
        }

        .fs-result { 
            padding: 24px;
            border-radius: 8px;
            width: 100%;
            height: 100%;
        }

        .fs-result h2 { 
            font-size: 24px;
        }

        .fs-result-header {
            flex-direction: column;
            gap: 12px;
        }

        .fs-result .close {
            align-self: flex-end;
        }

        .fs-result .snippet {
            font-size: 14px;
            padding: 16px;
        }

        .fs-result .keypoints li {
            padding: 10px 12px;
            font-size: 13px;
        }

        .fs-result .external a {
            font-size: 13px;
            padding: 8px 16px;
        }
    }

    @media (max-width: 480px) {
        .fs-result { 
            padding: 16px;
        }

        .fs-result h2 { 
            font-size: 20px;
        }

        .fs-result-section-title {
            font-size: 12px;
            margin: 16px 0 8px 0;
        }

        .fs-result .meta-item {
            font-size: 11px;
        }

        .fs-result .snippet {
            font-size: 13px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .fs-result .keypoints li {
            padding: 8px 10px;
            font-size: 12px;
        }
    }
    
        /* Fullscreen gallery */
        .fs-gallery-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(6,10,15,0.88);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 301;
            padding: 28px;
        }
        .fs-gallery-backdrop.open { display: flex; }

        .fs-gallery {
            width: 100%;
            max-width: 1200px;
            background: transparent;
            border-radius: 12px;
            padding: 12px;
            overflow: auto;
            color: #fff;
            position: relative;
        }

        .fs-gallery .close { position:absolute; top:8px; right:8px; background:transparent; border:none; color:#ddd; font-size:20px; cursor:pointer; }
        .fs-gallery .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; }
        .fs-gallery .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:12px; cursor:pointer; transition: transform 0.12s ease, box-shadow 0.12s ease; border:1px solid rgba(255,255,255,0.03); }
        .fs-gallery .card:hover { transform: translateY(-6px); box-shadow: 0 12px 40px rgba(0,0,0,0.5); }
        .fs-gallery .thumb { width:100%; height:160px; border-radius:8px; background-size:cover; background-position:center; margin-bottom:10px; }
        .fs-gallery .title { font-weight:600; font-size:16px; margin-bottom:6px; }
        .fs-gallery .card .meta { font-size:12px; color:rgba(255,255,255,0.65); margin-bottom:8px; }
        .fs-gallery .snippet { font-size:14px; color:rgba(255,255,255,0.9); line-height:1.45; max-height:86px; overflow:hidden; }

        @media (max-width:520px) {
            .fs-gallery .thumb { height:120px; }
        }

        </style>
        </head>



<body>

    <!-- SIDEBAR TOGGLE -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <!-- LEFT SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <button id="newChatBtn" class="nav-item">New Chat</button>
        <div class="nav-item">Search Chats</div>
        <div class="nav-item">Library</div>

        <h3>Projects</h3>
        <div class="nav-item">New Project</div>
        <div class="nav-item">Exam</div>

        <h3>Your Chats</h3>
        <div id="chatsList" class="chats-list">
            <!-- populated dynamically -->
        </div>
    </div>

    <!-- Color Controls Toggle -->
    <button id="colorControlsToggle" class="color-controls-toggle" aria-label="Toggle color controls" title="Toggle color controls">ðŸŽ¨</button>

    <!-- AUTH CONTROLS -->
    <div id="authControls" style="position:fixed;top:0.75rem;right:1rem;z-index:120;display:flex;gap:0.5rem;align-items:center"></div>

    <!-- Floating Auth Modal -->
    <div id="authModalBackdrop" class="auth-modal-backdrop" aria-hidden="true">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="authModalTitle">
            <button class="close-btn" id="authModalClose" title="Close">âœ•</button>
            <h3 id="authModalTitle">Sign in</h3>
            <div class="fields">
                <input id="authName" type="text" placeholder="Full name (for sign up)" style="display:none">
                <input id="authEmail" type="email" placeholder="Email">
                <input id="authPassword" type="password" placeholder="Password">
            </div>
            <div class="actions">
                <button id="authSubmit" class="primary">Continue</button>
                <button id="authToggleMode" class="secondary">Switch</button>
            </div>
            <div id="authError" style="margin-top:8px;color:#ffb4b4;font-size:13px;min-height:18px;">&nbsp;</div>
            <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
                <div style="flex:1; height:1px; background:rgba(255,255,255,0.04)"></div>
                <div style="opacity:0.6; font-size:12px;">or</div>
                <div style="flex:1; height:1px; background:rgba(255,255,255,0.04)"></div>
            </div>
            <div style="margin-top:10px;">
                <div id="authGoogleBtn" class="google-btn">Sign in with Google</div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Result Viewer -->
    <div id="fsResultBackdrop" class="fs-result-backdrop" aria-hidden="true">
        <div class="fs-result" role="dialog" aria-modal="true">
            <div class="fs-result-header">
                <div class="fs-result-title-group">
                    <h2 id="fsResultTitle">Result Title</h2>
                    <div class="meta" id="fsResultMeta">
                        <span class="meta-item">ðŸ“š <span id="fsResultSource">Source</span></span>
                        <span class="meta-item">â­ <span id="fsResultRelevance">Relevance</span></span>
                    </div>
                </div>
                <button class="close" id="fsResultClose" aria-label="Close result">âœ•</button>
            </div>
            <div class="fs-result-content">
                <div class="fs-result-section-title">ðŸ“„ Overview</div>
                <div class="snippet" id="fsResultSnippet">Short snippet...</div>
                
                <div class="fs-result-section-title">âœ¦ Key Points</div>
                <ul class="keypoints" id="fsResultKeypoints"></ul>
                
                <div class="external">
                    <a id="fsResultLink" href="#" target="_blank">View Full Article</a>
                </div>
            </div>
    
    <!-- Fullscreen Gallery -->
    <div id=\ fsGalleryBackdrop\ class=\fs-gallery-backdrop\ aria-hidden=\true\>
        <div class=\fs-gallery\ role=\dialog\ aria-modal=\true\>
            <button class=\close\ id=\fsGalleryClose\ aria-label=\Close gallery\>?</button>
            <div class=\grid\ id=\fsGalleryGrid\></div>
        </div>
    </div>;     </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main empty-state" id="mainContent">
        <br>
            <br>
                <br>
                    <br>
                        <br>
                            <br>
                                <br>
                                    <br>
                                        <br>
                                            <br>
                                                <br>
                                                    <br>    
                                                        <br>
                                                            <br>
                                                                <br>
                                                                    <br>
                                                                        <br>
                                                                            <br>
                                                                                <br>
                                                                                    <br>
                                                                                        <br>
                                                                                            <br>
                                                                                                <br>
                                                                                                    <br>
                                                                                                        <br>
                                                                                                            <br>
                                                                                                                <br>
                                                                                                                    <br>
                                                                                                                        <br>
                                                                                                                            <br>
        <div class="title" id="mainTitle">How can I help, Rahul?</div>

        <!-- Chat Container (hidden initially) -->
        <div class="chat-container" id="chatContainer"></div>
    </div>

    <!-- INPUT CONTAINER - Bottom Fixed Position - Single Search Bar -->
    <div class="input-container" id="inputContainer">
        <input type="text" id="searchInput" placeholder="Ask anything...">
        <div class="input-icons">
            <div id="voiceBtn" title="Voice input" aria-label="Voice input" role="button">
                <!-- Mic icon (attribution: Dave Gandy - Flaticon) -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19h2v3h-2z" />
                </svg>
            </div>
            <button id="typeBtn" title="Send" aria-label="Send" role="button">
                <!-- Hunter/target style icon (use Freepik - Flaticon attribution below) -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- 3D CANVAS -->
    <div id="container"></div>

    <!-- COLOR CONTROLS -->
    <div class="color-controls">
        <div class="color-scheme">
            <button class="active" id="cosmicBtn">
                <div class="color-preview cosmic"></div>
                <span>Cosmic</span>
            </button>
            <button id="neonBtn">
                <div class="color-preview neon"></div>
                <span>Neon</span>
            </button>
            <button id="sunsetBtn">
                <div class="color-preview sunset"></div>
                <span>Sunset</span>
            </button> 
            <button id="oceanBtn">
                <div class="color-preview ocean"></div>
                <span>Ocean</span>
            </button>
        </div>

    <!-- Flaticon attribution (required for free icon use) -->
    <div class="flaticon-attribution">Mic icons created by <a href="https://www.flaticon.com/free-icons/mic" target="_blank" rel="noopener noreferrer">Dave Gandy - Flaticon</a> Â· Hunter icons created by <a href="https://www.flaticon.com/free-icons/hunter" target="_blank" rel="noopener noreferrer">Freepik - Flaticon</a></div>
        <!-- Compact Theme toggle (single switch) -->
        <div class="theme-toggle" id="themeToggle">
            <label class="switch" title="Toggle Day / Night">
                <input type="checkbox" id="themeSwitch">
                <span class="slider">
                    <span class="icon sun">â˜€ï¸</span>
                    <span class="icon moon">ðŸŒ™</span>
                </span>
            </label>
        </div>

        <!-- Panel controls: move sphere/reset here (ids kept so JS listeners still work) -->
        <div class="panel-controls" id="panelControls">
            <button id="sphereBtn" title="Morph to Sphere">ðŸ”µ Sphere</button>
            <button id="resetBtn" title="Reset Particles">ðŸ” Reset</button>
        </div>
    </div>

    <!-- CONTROLS (kept empty; main action buttons moved into color-controls panel) -->
    <div class="controls"></div>

    <!-- FOOTER -->
    <footer class="footer">
        <div>
            Developed by <a href="#">Rahul Kumar</a>
            <span class="footer-divider">â€¢</span>
            <a href="#">Sneha Yadav</a>
        </div>
        <div style="margin-top: 0.5rem; font-size: 0.8rem;">
            Â© 2025 MinzoAI. All rights reserved.
        </div>
    </footer>

    <script>
        let scene, camera, renderer, particles;
        const count = 12000;
        let currentState = 'sphere';
        let currentColorScheme = 'cosmic';
        let isNightMode = true;

        // Chat history and sessions (persisted in localStorage)
        const CHAT_STORAGE_KEY = 'minzo_chat_history_v1';
        let chatHistory = {}; // { id: { id, title, createdAt, messages: [ {sender,text,metadata,timestamp} ] } }
        let currentChatId = null;

        function loadChatHistory() {
            try {
                const raw = localStorage.getItem(CHAT_STORAGE_KEY);
                if (!raw) return;
                chatHistory = JSON.parse(raw) || {};
            } catch (e) {
                console.error('âŒ Failed to parse chat history from storage', e);
                chatHistory = {};
            }
        }

        function saveChatHistory() {
            try {
                localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(chatHistory));
            } catch (e) {
                console.error('âŒ Failed to save chat history', e);
            }
        }

        function createNewChat(title) {
            const id = 'chat_' + Date.now();
            const createdAt = new Date().toISOString();
            chatHistory[id] = { id, title: title || `Chat ${new Date().toLocaleString()}`, createdAt, messages: [] };
            currentChatId = id;
            saveChatHistory();
            renderChatsList();
            clearChatUI();
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.classList.remove('empty-state');
                mainContent.classList.add('chat-mode');
            }
            const mainTitle = document.getElementById('mainTitle'); if (mainTitle) mainTitle.classList.add('hidden');
        }

        function renderChatsList() {
            const list = document.getElementById('chatsList');
            if (!list) return;
            list.innerHTML = '';
            const ids = Object.keys(chatHistory).sort((a,b) => (chatHistory[b].createdAt || 0) > (chatHistory[a].createdAt || 0) ? 1 : -1);
            ids.forEach(id => {
                const meta = chatHistory[id];
                const item = document.createElement('div');
                item.className = 'nav-item chat-list-item';
                item.setAttribute('data-chat-id', id);
                item.innerHTML = `<div style="font-weight:600;">${meta.title}</div><div style="font-size:0.8rem;opacity:0.7">${new Date(meta.createdAt).toLocaleString()}</div>`;
                item.addEventListener('click', () => openChat(id));
                list.appendChild(item);
            });
        }

        function openChat(id) {
            const chat = chatHistory[id];
            if (!chat) return;
            currentChatId = id;
            clearChatUI();
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.classList.remove('empty-state');
                mainContent.classList.add('chat-mode');
            }
            const mainTitle = document.getElementById('mainTitle'); if (mainTitle) mainTitle.classList.add('hidden');
            // render messages
            chat.messages.forEach(msg => {
                addMessageToChat(msg.text, msg.sender, msg.metadata || {}, { save: false });
            });
            // ensure scrolled
            scrollChatToBottom();
        }

        function clearChatUI() {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) chatContainer.innerHTML = '';
        }

        // Theme helpers: persisted preference overrides automatic time-based theme
        function applyTheme(isNight) {
            isNightMode = !!isNight;
            if (isNightMode) {
                document.body.classList.remove('light-mode');
            } else {
                document.body.classList.add('light-mode');
            }

            // Update renderer background and particle material
                if (renderer) {
                    renderer.setClearColor(isNightMode ? 0x000000 : 0xf5f5f7);
                }

                if (particles && particles.material) {
                    particles.material.size = window.innerWidth < 768 ? (isNightMode ? 0.06 : 0.05) : (isNightMode ? 0.08 : 0.06);
                    particles.material.opacity = isNightMode ? 0.8 : 0.6;
                    // Use additive blending in night, normal blending in day so dark particles are visible
                    particles.material.blending = isNightMode ? THREE.AdditiveBlending : THREE.NormalBlending;
                    particles.material.needsUpdate = true;

                    // Only update colors when particles exist
                    updateParticleColors();
                }

                // Update the UI switch state if present
                updateThemeButtons();
        }

        function setThemeByTime() {
            const hour = new Date().getHours();
            const autoNight = hour < 6 || hour >= 18; // Night from 6pm to 6am
            applyTheme(autoNight);
        }

        function saveThemePreference(pref) {
            try { localStorage.setItem('minzo_theme', pref); } catch (e) {}
        }

        function loadThemePreference() {
            try { return localStorage.getItem('minzo_theme'); } catch (e) { return null; }
        }

        function updateThemeButtons() {
            const themeSwitch = document.getElementById('themeSwitch');
            if (!themeSwitch) return;
            themeSwitch.checked = !!isNightMode;
        }

        // Color-controls collapse/expand persistence
        function saveColorControlsPref(collapsed) {
            try { localStorage.setItem('minzo_color_controls_collapsed', collapsed ? '1' : '0'); } catch (e) {}
        }

        function loadColorControlsPref() {
            try { return localStorage.getItem('minzo_color_controls_collapsed'); } catch (e) { return null; }
        }

        function setColorControlsCollapsed(collapsed) {
            const panel = document.querySelector('.color-controls');
            const toggle = document.getElementById('colorControlsToggle');
            if (!panel || !toggle) return;
            if (collapsed) {
                panel.classList.add('collapsed');
                toggle.setAttribute('title', 'Show color controls');
            } else {
                panel.classList.remove('collapsed');
                toggle.setAttribute('title', 'Hide color controls');
            }
            saveColorControlsPref(collapsed);
        }

        // Initialize the application
        function init() {
            // Load theme preference if present, otherwise set based on time
            const pref = loadThemePreference();
            if (pref === 'light') applyTheme(false);
            else if (pref === 'dark') applyTheme(true);
            else setThemeByTime();

            // Initialize Three.js
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(isNightMode ? 0x000000 : 0xf5f5f7);
            document.getElementById('container').appendChild(renderer.domElement);

            camera.position.z = 25;

            createParticles();
                setupEventListeners();

                // Load chat history and render sidebar
                loadChatHistory();
                renderChatsList();
                // If no chats exist yet, create a default one
                if (!Object.keys(chatHistory).length) {
                    createNewChat('Welcome Chat');
                } else {
                    // open the most recent chat
                    const ids = Object.keys(chatHistory).sort((a,b) => (chatHistory[b].createdAt || 0) > (chatHistory[a].createdAt || 0) ? 1 : -1);
                    openChat(ids[0]);
                }

            // Ensure theme switch is synced to current theme now that DOM listeners and particles exist
            updateThemeButtons();
            // Apply saved color-controls collapsed state (default: collapsed = false)
            const ccPref = loadColorControlsPref();
            if (ccPref === '1') setColorControlsCollapsed(true);
            else setColorControlsCollapsed(false);

            animate();

            // Start the MinzoAI text loop
            startMinzoAILoop();
        }

        // Create particles with current color scheme
        function createParticles() {
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(count * 3);
            const colors = new Float32Array(count * 3);

            function sphericalDistribution(i) {
                const phi = Math.acos(-1 + (2 * i) / count);
                const theta = Math.sqrt(count * Math.PI) * phi;
                
                return {
                    x: 8 * Math.cos(theta) * Math.sin(phi),
                    y: 8 * Math.sin(theta) * Math.sin(phi),
                    z: 8 * Math.cos(phi)
                };
            }

            for (let i = 0; i < count; i++) {
                const point = sphericalDistribution(i);
                
                positions[i * 3] = point.x + (Math.random() - 0.5) * 0.5;
                positions[i * 3 + 1] = point.y + (Math.random() - 0.5) * 0.5;
                positions[i * 3 + 2] = point.z + (Math.random() - 0.5) * 0.5;

                const color = new THREE.Color();
                const depth = Math.sqrt(point.x * point.x + point.y * point.y + point.z * point.z) / 8;
                
                // Apply color scheme
                applyColorScheme(color, depth);

                colors[i * 3] = color.r;
                colors[i * 3 + 1] = color.g;
                colors[i * 3 + 2] = color.b;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: isNightMode ? 0.08 : 0.06,
                vertexColors: true,
                blending: THREE.AdditiveBlending,
                transparent: true,
                opacity: isNightMode ? 0.8 : 0.6,
                sizeAttenuation: true
            });

            if (particles) scene.remove(particles);
            particles = new THREE.Points(geometry, material);
            particles.rotation.x = 0;
            particles.rotation.y = 0;
            particles.rotation.z = 0;
            scene.add(particles);
        }

        // Apply color scheme to particles
        function applyColorScheme(color, depth) {
            switch(currentColorScheme) {
                case 'cosmic':
                    color.setHSL(0.5 + depth * 0.2, 0.7, isNightMode ? (0.4 + depth * 0.3) : (0.2 + depth * 0.2));
                    break;
                case 'neon':
                    color.setHSL(0.3 + depth * 0.3, 0.9, isNightMode ? (0.5 + depth * 0.2) : (0.3 + depth * 0.2));
                    break;
                case 'sunset':
                    color.setHSL(0.05 + depth * 0.1, 0.8, isNightMode ? (0.5 + depth * 0.2) : (0.3 + depth * 0.2));
                    break;
                case 'ocean':
                    color.setHSL(0.6 + depth * 0.1, 0.8, isNightMode ? (0.4 + depth * 0.3) : (0.2 + depth * 0.2));
                    break;
            }
        }

        // Setup event listeners for all interactive elements
        function setupEventListeners() {
            // Sidebar toggle
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                // For mobile, we use a different class
                if (window.innerWidth <= 768) {
                    sidebar.classList.toggle('active');
                }
            });

            // Color scheme buttons
            const cosmicBtn = document.getElementById('cosmicBtn');
            const neonBtn = document.getElementById('neonBtn');
            const sunsetBtn = document.getElementById('sunsetBtn');
            const oceanBtn = document.getElementById('oceanBtn');
            
            cosmicBtn.addEventListener('click', () => setColorScheme('cosmic'));
            neonBtn.addEventListener('click', () => setColorScheme('neon'));
            sunsetBtn.addEventListener('click', () => setColorScheme('sunset'));
            oceanBtn.addEventListener('click', () => setColorScheme('ocean'));

            // Theme switch
            const themeSwitch = document.getElementById('themeSwitch');
            if (themeSwitch) {
                themeSwitch.addEventListener('change', () => {
                    const isDark = themeSwitch.checked; // checked => night/dark
                    applyTheme(isDark);
                    saveThemePreference(isDark ? 'dark' : 'light');
                });
            }

            // Color-controls toggle
            const colorToggle = document.getElementById('colorControlsToggle');
            if (colorToggle) {
                colorToggle.addEventListener('click', () => {
                    const panel = document.querySelector('.color-controls');
                    if (!panel) return;
                    const collapsed = panel.classList.toggle('collapsed');
                    setColorControlsCollapsed(collapsed);
                });
            }

            // Control buttons
            const sphereBtn = document.getElementById('sphereBtn');
            const resetBtn = document.getElementById('resetBtn');
            
            sphereBtn.addEventListener('click', () => morphToSphere());
            resetBtn.addEventListener('click', () => resetParticles());

            // Single unified search input
            const searchInput = document.getElementById('searchInput');
            const typeBtn = document.getElementById('typeBtn');
            const voiceBtn = document.getElementById('voiceBtn');

            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const q = searchInput.value.trim();
                        if (q) {
                            performSearch(q);
                            searchInput.value = ''; // Clear input after sending
                        }
                    }
                });
            }

            if (typeBtn) {
                typeBtn.addEventListener('click', () => {
                    const q = searchInput.value.trim();
                    if (q) {
                        performSearch(q);
                        searchInput.value = ''; // Clear input after sending
                    }
                });
            }

            // Auth controls wiring
            const authControls = document.getElementById('authControls');
            function updateAuthUI() {
                const token = localStorage.getItem('minzo_token');
                authControls.innerHTML = '';
                if (token) {
                    try { setupSSE(token); } catch (e) {}
                    const user = JSON.parse(localStorage.getItem('minzo_user') || 'null');
                    const span = document.createElement('div');
                    span.style.padding = '6px 10px';
                    span.style.background = 'rgba(255,255,255,0.06)';
                    span.style.borderRadius = '14px';
                    span.textContent = user && user.name ? `Hi, ${user.name}` : (user && user.email ? user.email : 'Logged In');
                    authControls.appendChild(span);

                    const logoutBtn = document.createElement('button');
                    logoutBtn.textContent = 'Logout';
                    logoutBtn.style.padding = '6px 10px';
                    logoutBtn.addEventListener('click', () => {
                        localStorage.removeItem('minzo_token');
                        localStorage.removeItem('minzo_user');
                        updateAuthUI();
                    });
                    authControls.appendChild(logoutBtn);
                } else {
                    const loginBtn = document.createElement('button');
                    loginBtn.textContent = 'Login';
                    loginBtn.style.padding = '6px 10px';
                    loginBtn.addEventListener('click', () => showAuthModal('login'));
                    authControls.appendChild(loginBtn);

                    const regBtn = document.createElement('button');
                    regBtn.textContent = 'Sign up';
                    regBtn.style.padding = '6px 10px';
                    regBtn.addEventListener('click', () => showAuthModal('register'));
                    authControls.appendChild(regBtn);

                    const googleBtn = document.createElement('button');
                    googleBtn.textContent = 'Sign in with Google';
                    googleBtn.style.padding = '6px 10px';
                    googleBtn.addEventListener('click', () => {
                        window.location.href = 'http://localhost:3001/auth/google';
                    });
                    authControls.appendChild(googleBtn);
                }
            }

            updateAuthUI();

            if (voiceBtn) {
                voiceBtn.addEventListener('click', () => {
                    console.log('ðŸŽ¤ Voice input feature coming soon');
                    // TODO: Implement voice input
                });
            }

                // New chat button
                const newChatBtn = document.getElementById('newChatBtn');
                if (newChatBtn) {
                    newChatBtn.addEventListener('click', () => {
                        createNewChat('New Chat');
                        // collapse sidebar on mobile
                        const sidebar = document.getElementById('sidebar');
                        if (sidebar && window.innerWidth <= 768) sidebar.classList.remove('active');
                    });
                }
        }

        // Set color scheme
        function setColorScheme(scheme) {
            currentColorScheme = scheme;
            
            // Update active button
            document.querySelectorAll('.color-scheme button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(scheme + 'Btn').classList.add('active');
            
            // Update particles
            updateParticleColors();
        }

        // Update particle colors
        function updateParticleColors() {
            const colors = particles.geometry.attributes.color.array;
            const positions = particles.geometry.attributes.position.array;
            
            for (let i = 0; i < count; i++) {
                const depth = Math.sqrt(
                    positions[i * 3] * positions[i * 3] + 
                    positions[i * 3 + 1] * positions[i * 3 + 1] + 
                    positions[i * 3 + 2] * positions[i * 3 + 2]
                ) / 8;
                
                const color = new THREE.Color();
                applyColorScheme(color, depth);
                
                colors[i * 3] = color.r;
                colors[i * 3 + 1] = color.g;
                colors[i * 3 + 2] = color.b;
            }
            
            particles.geometry.attributes.color.needsUpdate = true;
        }

        // Perform backend search/chat request
        async function performSearch(query) {
            console.log('ðŸ” Search initiated with query:', query);
            
            const chatContainer = document.getElementById('chatContainer');
            const mainContent = document.getElementById('mainContent');
            const mainTitle = document.getElementById('mainTitle');
            const searchInput = document.getElementById('searchInput');

            if (!chatContainer || !mainContent || !mainTitle) {
                console.error('âŒ Required elements not found:', {
                    chatContainer: !!chatContainer,
                    mainContent: !!mainContent,
                    mainTitle: !!mainTitle
                });
                return;
            }

            // Add user message to chat
            addMessageToChat(query, 'user');
            
            // Switch to chat mode
            mainContent.classList.remove('empty-state');
            mainContent.classList.add('chat-mode');
            mainTitle.classList.add('hidden');

            console.log('âœ… Chat mode activated');

            // Show typing indicator
            addTypingIndicator();

            try {
                console.log('ðŸ“¤ Sending request to http://localhost:3001/api/chat');
                
                const token = localStorage.getItem('minzo_token');
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = 'Bearer ' + token;
                const res = await fetch('http://localhost:3001/api/chat', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ message: query })
                });

                console.log('ðŸ“¥ Response received:', res.status, res.statusText);

                // Remove typing indicator
                removeTypingIndicator();

                if (!res.ok) {
                    throw new Error(`Server error: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                console.log('âœ… Response parsed:', data);
                
                if (data && data.success) {
                    const text = data.response || JSON.stringify(data);
                    // Pass metadata to the message function
                    const metadata = {
                        confidence: data.confidence,
                        source: data.source,
                        topic: data.topic,
                        learned: data.learned
                    };
                    addMessageToChat(text, 'assistant', metadata);

                    // If backend returned web results, open the clean full-screen viewer
                    try {
                        if (data.webResults && Array.isArray(data.webResults) && data.webResults.length > 0) {
                            // Show gallery for multiple results, single viewer for one result
                            if (data.webResults.length > 1) {
                                showFullScreenGallery(data.webResults);
                            } else {
                                showFullScreenResult(data.webResults[0]);
                            }
                        }
                    } catch (e) { console.warn('Failed to show full screen result', e); }
                } else {
                    addMessageToChat(data.error || 'No response from server', 'assistant');
                }
            } catch (err) {
                console.error('âŒ Error during search:', err);
                removeTypingIndicator();
                const errorMsg = err.message || 'Unknown error';
                
                // Check if it's a connection error
                if (errorMsg.includes('fetch') || !navigator.onLine) {
                    addMessageToChat('âš ï¸ Cannot connect to server. Make sure the backend is running on http://localhost:3001', 'assistant');
                } else {
                    addMessageToChat('âŒ Error: ' + errorMsg, 'assistant');
                }
            }

            scrollChatToBottom();
        }

        // Full-screen result helper
        function showFullScreenResult(result) {
            try {
                const backdrop = document.getElementById('fsResultBackdrop');
                const title = document.getElementById('fsResultTitle');
                const source = document.getElementById('fsResultSource');
                const relevance = document.getElementById('fsResultRelevance');
                const snippet = document.getElementById('fsResultSnippet');
                const keypoints = document.getElementById('fsResultKeypoints');
                const link = document.getElementById('fsResultLink');
                const close = document.getElementById('fsResultClose');

                if (!backdrop) return;

                title.textContent = result.title || result.heading || result.name || 'Result';
                source.textContent = result.source || 'AI Knowledge Base';
                relevance.textContent = result.relevance ? `${Math.round(result.relevance * 100)}%` : '85%';
                snippet.textContent = result.snippet || (result.content && result.content.substring(0, 500)) || 'No description available.';

                // populate keypoints
                keypoints.innerHTML = '';
                const points = result.keyPoints || result.keypoints || [];
                if (points.length === 0) {
                    // Generate key points from snippet if not provided
                    const text = result.snippet || result.content || '';
                    const sentences = text.split('.').filter(s => s.trim().length > 20).slice(0, 5);
                    sentences.forEach(sentence => {
                        const li = document.createElement('li');
                        li.textContent = sentence.trim() + '.';
                        keypoints.appendChild(li);
                    });
                } else {
                    points.slice(0, 8).forEach(p => {
                        const li = document.createElement('li');
                        li.textContent = p;
                        keypoints.appendChild(li);
                    });
                }

                link.href = result.link || result.url || '#';
                link.textContent = result.link ? 'View Full Article' : (result.url ? 'Open Source' : 'Learn More');

                // open
                backdrop.classList.add('open');
                backdrop.setAttribute('aria-hidden', 'false');

                // handlers
                close.onclick = () => closeFullScreenResult();
                backdrop.addEventListener('click', (e) => {
                    if (e.target === backdrop) closeFullScreenResult();
                });
                document.onkeydown = (e) => { if (e.key === 'Escape') closeFullScreenResult(); };
            } catch (e) { console.warn('showFullScreenResult error', e); }
        }

        function closeFullScreenResult() {
            const backdrop = document.getElementById('fsResultBackdrop');
            if (!backdrop) return;
            backdrop.classList.remove('open');
            backdrop.setAttribute('aria-hidden', 'true');
            document.onkeydown = null;
        }

        function showFullScreenGallery(results) {
            if (!Array.isArray(results) || results.length === 0) return;
            const backdrop = document.getElementById('fsGalleryBackdrop');
            if (!backdrop) return;
            const grid = backdrop.querySelector('#fsGalleryGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            results.forEach((result, idx) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';
                card.innerHTML = `
                    <div class="thumb" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 3em; color: white;">ðŸ“„</div>
                    <div class="title">${(result.title || 'Untitled').substring(0, 50)}</div>
                    <div class="meta">${result.source || 'Unknown'}</div>
                    <div class="snippet">${(result.snippet || '').substring(0, 60)}...</div>
                `;
                card.addEventListener('click', () => {
                    closeFullScreenGallery();
                    showFullScreenResult(result);
                });
                grid.appendChild(card);
            });
            
            backdrop.classList.add('open');
            backdrop.setAttribute('aria-hidden', 'false');
            document.onkeydown = (e) => { if (e.key === 'Escape') closeFullScreenGallery(); };
        }

        function closeFullScreenGallery() {
            const backdrop = document.getElementById('fsGalleryBackdrop');
            if (!backdrop) return;
            backdrop.classList.remove('open');
            backdrop.setAttribute('aria-hidden', 'true');
            document.onkeydown = null;
        }

            // AUTH helpers and floating modal
            let _authModalInitialized = false;
            function showAuthModal(mode = 'login') {
                const backdrop = document.getElementById('authModalBackdrop');
                const modal = backdrop && backdrop.querySelector('.auth-modal');
                const title = modal && modal.querySelector('h3');
                const nameInput = document.getElementById('authName');
                const emailInput = document.getElementById('authEmail');
                const passInput = document.getElementById('authPassword');
                const submitBtn = document.getElementById('authSubmit');
                const toggleBtn = document.getElementById('authToggleMode');
                const closeBtn = document.getElementById('authModalClose');
                const googleBtn = document.getElementById('authGoogleBtn');

                if (!backdrop || !modal) {
                    // fallback to prompt behavior
                    const email = prompt('Email:');
                    if (!email) return;
                    const password = prompt('Password:');
                    if (!password) return;
                    fetch('http://localhost:3001/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) })
                        .then(r => r.json()).then(d => { if (d && d.success && d.token) { localStorage.setItem('minzo_token', d.token); localStorage.setItem('minzo_user', JSON.stringify(d.user || null)); location.reload(); } else alert('Login failed'); })
                        .catch(() => alert('Login error'));
                    return;
                }

                // populate mode UI
                const isRegister = mode === 'register';
                title.textContent = isRegister ? 'Sign up' : 'Sign in';
                nameInput.style.display = isRegister ? 'block' : 'none';
                toggleBtn.textContent = isRegister ? 'Switch to Login' : 'Switch to Sign up';
                submitBtn.textContent = isRegister ? 'Create account' : 'Continue';

                // focus
                emailInput.value = '';
                passInput.value = '';
                nameInput.value = '';
                emailInput.focus();

                // open
                backdrop.classList.add('open');
                backdrop.setAttribute('aria-hidden', 'false');

                if (!_authModalInitialized) {
                    _authModalInitialized = true;

                    const authErrorDiv = document.getElementById('authError');
                    function setAuthError(msg) {
                        if (!authErrorDiv) return;
                        authErrorDiv.textContent = msg || '\u00A0';
                    }

                    // submit handler
                    submitBtn.addEventListener('click', async () => {
                        setAuthError('');
                        const email = emailInput.value && emailInput.value.trim();
                        const password = passInput.value && passInput.value.trim();
                        const name = nameInput.value && nameInput.value.trim();
                        if (!email || !password) { setAuthError('Please provide email and password'); return; }

                        if (title.textContent.toLowerCase().includes('sign up')) {
                            try {
                                const res = await fetch('http://localhost:3001/api/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password, name: name || email.split('@')[0] }) });
                                const data = await res.json();
                                if (data && data.success && data.token) {
                                    localStorage.setItem('minzo_token', data.token);
                                    localStorage.setItem('minzo_user', JSON.stringify(data.user || null));
                                    backdrop.classList.remove('open');
                                    location.reload();
                                } else {
                                    setAuthError('Register failed: ' + (data && data.error ? data.error : 'unknown'));
                                }
                            } catch (e) { setAuthError('Register error: ' + (e && e.message ? e.message : 'network')); }
                        } else {
                            try {
                                const res = await fetch('http://localhost:3001/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
                                const data = await res.json();
                                if (data && data.success && data.token) {
                                    localStorage.setItem('minzo_token', data.token);
                                    localStorage.setItem('minzo_user', JSON.stringify(data.user || null));
                                    backdrop.classList.remove('open');
                                    location.reload();
                                } else {
                                    setAuthError('Login failed: ' + (data && data.error ? data.error : 'unknown'));
                                }
                            } catch (e) { setAuthError('Login error: ' + (e && e.message ? e.message : 'network')); }
                        }
                    });

                    // toggle mode
                    toggleBtn.addEventListener('click', () => {
                        const nowRegister = title.textContent.toLowerCase().includes('sign in');
                        showAuthModal(nowRegister ? 'register' : 'login');
                    });

                    // google
                    googleBtn.addEventListener('click', () => {
                        window.location.href = 'http://localhost:3001/auth/google';
                    });

                    // close handlers
                    closeBtn.addEventListener('click', () => { backdrop.classList.remove('open'); backdrop.setAttribute('aria-hidden', 'true'); setAuthError(''); });
                    backdrop.addEventListener('click', (e) => { if (e.target === backdrop) { backdrop.classList.remove('open'); backdrop.setAttribute('aria-hidden', 'true'); setAuthError(''); } });
                }
            }

            // If redirected back with token in URL hash (#token=...), pick it up
            function pickTokenFromHash() {
                if (window.location.hash && window.location.hash.includes('token=')) {
                    const m = window.location.hash.match(/token=([^&]+)/);
                    if (m && m[1]) {
                        const token = decodeURIComponent(m[1]);
                        localStorage.setItem('minzo_token', token);
                        // optionally fetch /api/me
                        fetch('http://localhost:3001/api/me', { headers: { 'Authorization': 'Bearer ' + token } })
                            .then(r => r.json()).then(d => {
                                if (d && d.success && d.user) localStorage.setItem('minzo_user', JSON.stringify(d.user));
                                window.location.hash = '';
                                setupSSE(token);
                                location.reload();
                            }).catch(() => { window.location.hash = ''; location.reload(); });
                    }
                }
            }

            pickTokenFromHash();

            // SSE client for real-time updates
            let _minzoSse = null;
            function setupSSE(token) {
                try {
                    if (_minzoSse) {
                        try { _minzoSse.close(); } catch (e) {}
                    }
                    const url = `http://localhost:3001/api/stream?token=${encodeURIComponent(token)}`;
                    _minzoSse = new EventSource(url);
                    _minzoSse.addEventListener('interaction', (e) => {
                        try {
                            const interaction = JSON.parse(e.data);
                            // interaction: { id, userId, userInput, aiResponse, timestamp }
                            // Append to current chat UI if user is viewing their chats
                            // Create both user & assistant messages for real-time sync
                            const chatContainer = document.getElementById('chatContainer');
                            // Avoid duplication: check last assistant message
                            if (interaction.userInput) {
                                addMessageToChat(interaction.userInput, 'user', {}, { save: true });
                            }
                            if (interaction.aiResponse) {
                                let dup = false;
                                if (chatContainer) {
                                    const assistantMessages = Array.from(chatContainer.querySelectorAll('.message-wrapper.assistant .message-text'));
                                    if (assistantMessages.length > 0) {
                                        const last = assistantMessages[assistantMessages.length - 1].textContent || '';
                                        if (last.trim() === interaction.aiResponse.trim()) dup = true;
                                    }
                                }
                                if (!dup) addMessageToChat(interaction.aiResponse, 'assistant', {}, { save: true });
                            }
                            scrollChatToBottom();
                        } catch (err) {
                            console.error('SSE parse error', err);
                        }
                    });
                    _minzoSse.onerror = (err) => { console.warn('SSE error', err); };
                } catch (e) {
                    console.warn('Failed to setup SSE:', e);
                }
            }

        // Add message to chat
        function addMessageToChat(text, sender, metadata = {}, options = { save: true }) {
            const chatContainer = document.getElementById('chatContainer');
            
            if (!chatContainer) {
                console.error('âŒ Chat container not found!');
                return;
            }

            console.log(`ðŸ“¨ Adding ${sender} message:`, text);
            
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message-wrapper ${sender}`;

            const messageAvatar = document.createElement('div');
            messageAvatar.className = 'message-avatar';
            messageAvatar.textContent = sender === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.textContent = text;

            messageContent.appendChild(messageText);

            // Add metadata if provided
            if (sender === 'assistant' && Object.keys(metadata).length > 0) {
                const metadataDiv = document.createElement('div');
                metadataDiv.className = 'message-metadata';

                if (metadata.confidence) {
                    const confItem = document.createElement('div');
                    confItem.className = 'metadata-item';
                    confItem.innerHTML = `<span>ðŸŽ¯ Confidence: ${Math.round(metadata.confidence * 100)}%</span>`;
                    metadataDiv.appendChild(confItem);
                }

                if (metadata.source) {
                    const sourceItem = document.createElement('div');
                    sourceItem.className = 'metadata-item';
                    sourceItem.innerHTML = `<span>ðŸ“š Source: ${metadata.source}</span>`;
                    metadataDiv.appendChild(sourceItem);
                }

                if (metadata.topic) {
                    const topicItem = document.createElement('div');
                    topicItem.className = 'metadata-item';
                    topicItem.innerHTML = `<span>ðŸ·ï¸ Topic: ${metadata.topic}</span>`;
                    metadataDiv.appendChild(topicItem);
                }

                if (metadata.learned) {
                    const learnedItem = document.createElement('div');
                    learnedItem.className = 'metadata-item';
                    learnedItem.innerHTML = `<span>âœ… Learned & Stored</span>`;
                    metadataDiv.appendChild(learnedItem);
                }

                messageContent.appendChild(metadataDiv);
            }

            messageWrapper.appendChild(messageAvatar);
            messageWrapper.appendChild(messageContent);
            chatContainer.appendChild(messageWrapper);
            
            console.log('âœ… Message added to chat');
            // Persist to history unless explicitly disabled
            try {
                if (options && options.save !== false) {
                    // Ensure we have an active chat session
                    if (!currentChatId) {
                        createNewChat();
                    }
                    const msgObj = { sender, text, metadata: metadata || {}, timestamp: new Date().toISOString() };
                    if (!chatHistory[currentChatId]) chatHistory[currentChatId] = { id: currentChatId, title: `Chat ${new Date().toLocaleString()}`, createdAt: new Date().toISOString(), messages: [] };
                    chatHistory[currentChatId].messages.push(msgObj);
                    // Update title if it's still a generic "New Chat"
                    if (!chatHistory[currentChatId].title || chatHistory[currentChatId].title.startsWith('Chat')) {
                        const firstUser = chatHistory[currentChatId].messages.find(m => m.sender === 'user');
                        if (firstUser) chatHistory[currentChatId].title = firstUser.text.slice(0, 60) + (firstUser.text.length > 60 ? 'â€¦' : '');
                    }
                    saveChatHistory();
                    renderChatsList();
                }
            } catch (e) {
                console.error('âŒ Error saving chat message to history', e);
            }
        }

        // Add typing indicator
        function addTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper assistant';
            messageWrapper.id = 'typing-indicator';

            const messageAvatar = document.createElement('div');
            messageAvatar.className = 'message-avatar';
            messageAvatar.textContent = 'ðŸ¤–';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';

            messageContent.appendChild(typingIndicator);
            messageWrapper.appendChild(messageAvatar);
            messageWrapper.appendChild(messageContent);
            chatContainer.appendChild(messageWrapper);
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Scroll chat to bottom
        // Scroll chat to bottom
        function scrollChatToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // Create text points
        function createTextPoints(text) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const fontSize = 100;
            const padding = 20;

            ctx.font = `bold ${fontSize}px Arial`;
            const textMetrics = ctx.measureText(text);
            const textWidth = textMetrics.width;
            const textHeight = fontSize;

            canvas.width = textWidth + padding * 2;
            canvas.height = textHeight + padding * 2;

            ctx.fillStyle = isNightMode ? 'white' : 'black';
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'center';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            const points = [];
            const threshold = 128;

            for (let i = 0; i < pixels.length; i += 4) {
                if (pixels[i] > threshold) {
                    const x = (i / 4) % canvas.width;
                    const y = Math.floor((i / 4) / canvas.width);
                    
                    if (Math.random() < 0.3) {
                        points.push({
                            x: (x - canvas.width / 2) / (fontSize / 10),
                            y: -(y - canvas.height / 2) / (fontSize / 10)
                        });
                    }
                }
            }

            return points;
        }

        // Morph to text
        function morphToText(text) {
            currentState = 'text';
            const textPoints = createTextPoints(text);
            const positions = particles.geometry.attributes.position.array;
            const targetPositions = new Float32Array(count * 3);

            // Prepare color changes so text points are visible in light mode
            const colors = particles.geometry.attributes.color.array;

            gsap.to(particles.rotation, {
                x: 0,
                y: 0,
                z: 0,
                duration: 0.5
            });

            for (let i = 0; i < count; i++) {
                if (i < textPoints.length) {
                    targetPositions[i * 3] = textPoints[i].x;
                    targetPositions[i * 3 + 1] = textPoints[i].y;
                    targetPositions[i * 3 + 2] = 0;
                    // If day mode, set text particles to dark color so they are visible
                    if (!isNightMode) {
                        colors[i * 3] = 0.05; // dark gray
                        colors[i * 3 + 1] = 0.05;
                        colors[i * 3 + 2] = 0.05;
                    }
                } else {
                    const angle = Math.random() * Math.PI * 2;
                    const radius = Math.random() * 20 + 10;
                    targetPositions[i * 3] = Math.cos(angle) * radius;
                    targetPositions[i * 3 + 1] = Math.sin(angle) * radius;
                    targetPositions[i * 3 + 2] = (Math.random() - 0.5) * 10;
                }
            }

            for (let i = 0; i < positions.length; i += 3) {
                gsap.to(particles.geometry.attributes.position.array, {
                    [i]: targetPositions[i],
                    [i + 1]: targetPositions[i + 1],
                    [i + 2]: targetPositions[i + 2],
                    duration: 2,
                    ease: "power2.inOut",
                    onUpdate: () => {
                        particles.geometry.attributes.position.needsUpdate = true;
                        particles.geometry.attributes.color.needsUpdate = true;
                    }
                });
            }
        }

        // Morph to sphere
        function morphToSphere() {
            currentState = 'sphere';
            const positions = particles.geometry.attributes.position.array;
            const targetPositions = new Float32Array(count * 3);

            function sphericalDistribution(i) {
                const phi = Math.acos(-1 + (2 * i) / count);
                const theta = Math.sqrt(count * Math.PI) * phi;
                
                return {
                    x: 8 * Math.cos(theta) * Math.sin(phi),
                    y: 8 * Math.sin(theta) * Math.sin(phi),
                    z: 8 * Math.cos(phi)
                };
            }

            for (let i = 0; i < count; i++) {
                const point = sphericalDistribution(i);
                
                targetPositions[i * 3] = point.x + (Math.random() - 0.5) * 0.5;
                targetPositions[i * 3 + 1] = point.y + (Math.random() - 0.5) * 0.5;
                targetPositions[i * 3 + 2] = point.z + (Math.random() - 0.5) * 0.5;
            }

            for (let i = 0; i < positions.length; i += 3) {
                gsap.to(particles.geometry.attributes.position.array, {
                    [i]: targetPositions[i],
                    [i + 1]: targetPositions[i + 1],
                    [i + 2]: targetPositions[i + 2],
                    duration: 2,
                    ease: "power2.inOut",
                    onUpdate: () => {
                        particles.geometry.attributes.position.needsUpdate = true;
                    }
                });
            }
        }

        // Reset particles
        function resetParticles() {
            createParticles();
            currentState = 'sphere';
        }

        // Start MinzoAI text loop
        function startMinzoAILoop() {
            // Show MinzoAI text initially
            setTimeout(() => {
                morphToText('minzoAI');
                
                // Then create a loop that shows MinzoAI every 10 seconds
                setInterval(() => {
                    if (currentState === 'sphere') {
                        morphToText('minzoAI');
                        setTimeout(() => {
                            morphToSphere();
                        }, 4000);
                    }
                }, 10000);
            }, 2000);
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            if (currentState === 'sphere') {
                particles.rotation.y += 0.002;
            }
            
            renderer.render(scene, camera);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            // Adjust particle size based on screen size
            if (particles && particles.material) {
                particles.material.size = window.innerWidth < 768 ? 
                    (isNightMode ? 0.06 : 0.05) : 
                    (isNightMode ? 0.08 : 0.06);
                particles.material.needsUpdate = true;
            }
        });

        // Update CSS --vh variable for mobile browsers (handles address bar / keyboard issues)
        function updateVh() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // Initial set and listeners
        updateVh();
        window.addEventListener('resize', updateVh);
        window.addEventListener('orientationchange', () => { setTimeout(updateVh, 300); });

        // Optional: when input gets focus (keyboard opens), ensure chat scrolls and input remains visible
        document.addEventListener('focusin', (e) => {
            if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) {
                setTimeout(() => {
                    const chatContainer = document.getElementById('chatContainer');
                    if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
                    updateVh();
                }, 300);
            }
        });

        document.addEventListener('focusout', () => { setTimeout(updateVh, 300); });

        // Initialize the application
        init();
    </script>
</body>
</html>

