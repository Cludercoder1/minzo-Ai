<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="minzo-backend" content="%REACT_APP_BACKEND_URL%">
<title>minzoAI Dashboard v10.1</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.7.1/gsap.min.js"></script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Inter', sans-serif;
    }

    /* ============================================
       V10.1 UI/UX ENHANCEMENTS - CSS VARIABLES
    ============================================ */
    :root {
        --vh: 1vh;
        --sidebar-width: 280px;
        --chat-max-width: 900px;
        --radius-lg: 20px;
        --radius-md: 14px;
        --radius-sm: 8px;
        --shadow-sm: 0 2px 12px rgba(0,0,0,0.08);
        --shadow-md: 0 8px 30px rgba(0,0,0,0.12);
        --shadow-lg: 0 20px 60px rgba(0,0,0,0.2);
        --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
    }

    html, body {
        height: 100%;
    }

    body {
        background: #121212;
        color: #ffffff;
        display: flex;
        height: calc(var(--vh, 1vh) * 100);
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        touch-action: manipulation;
        transition: all 0.5s var(--transition-smooth);
    }

    body.light-mode {
        background: #f5f5f7;
        color: #333333;
    }

    /* ============================================
       SIDEBAR V10.1 ENHANCEMENTS
    ============================================ */
    .sidebar {
        width: var(--sidebar-width);
        background: rgba(26, 26, 26, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.07);
        padding: 24px 16px;
        transition: all 0.3s var(--transition-smooth);
        box-shadow: 4px 0 30px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        z-index: 10;
        position: relative;
    }

    .light-mode .sidebar {
        background: rgba(255, 255, 255, 0.95);
        border-right: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 4px 0 30px rgba(0, 0, 0, 0.05);
    }

    /* collapsed state on desktops: keep a slim visible bar rather than fully hidden */
    .sidebar.collapsed {
        transform: none;
        width: 72px;
        padding: 12px 8px;
        border-right: 1px solid rgba(255, 255, 255, 0.03);
    }

    .sidebar h3 {
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255, 255, 255, 0.5);
        margin: 32px 0 12px 12px;
        padding-bottom: 6px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* When collapsed, reduce text presence and spacing to a slim icon-like bar */
    .sidebar.collapsed h3,
    .sidebar.collapsed .nav-item .nav-text,
    .sidebar.collapsed .project-list-item,
    .sidebar.collapsed .chats-list {
        opacity: 0.0;
        height: 0;
        width: 0;
        margin: 0;
        overflow: hidden;
        pointer-events: none;
    }

    .sidebar.collapsed .nav-item { 
        padding: 8px 6px;
        text-align: center;
        white-space: nowrap;
        max-width: 52px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .sidebar.collapsed .nav-item .nav-icon { font-size: 18px; }

    .sidebar.collapsed .nav-item:hover {
        transform: none;
        box-shadow: none;
    }

    .sidebar.collapsed .nav-item::before {
        content: "•";
        display: inline-block;
        transform: scale(1.4);
        margin-right: 0;
    }

    .light-mode .sidebar h3 {
        color: rgba(0, 0, 0, 0.5);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .nav-item, .chat-list-item, .project-list-item {
        padding: 14px 16px;
        border-radius: var(--radius-md);
        margin-bottom: 6px;
        cursor: pointer;
        transition: all 0.25s var(--transition-smooth);
        border: 1px solid transparent;
        position: relative;
        overflow: hidden;
        color: #ddd;
        background: transparent;
        border: none;
        text-align: left;
        font-size: 14px;
    }

    .nav-item { display: flex; align-items: center; gap: 0.75rem; }
    .nav-icon { width: 32px; display: inline-flex; align-items:center; justify-content:center; font-size:18px; }
    .nav-text { display:inline-block; transition: opacity 0.18s ease, width 0.2s ease, margin 0.18s ease; max-width: calc(var(--sidebar-width) - 80px); }
    .nav-text > div { display:block; }

    .nav-item:hover, .chat-list-item:hover, .project-list-item:hover {
        background: rgba(255, 255, 255, 0.07);
        border-color: rgba(255, 255, 255, 0.1);
        transform: translateX(4px);
        box-shadow: var(--shadow-sm);
    }

    .light-mode .nav-item,
    .light-mode .chat-list-item,
    .light-mode .project-list-item {
        color: #555;
    }

    .light-mode .nav-item:hover,
    .light-mode .chat-list-item:hover,
    .light-mode .project-list-item:hover {
        background: rgba(0, 0, 0, 0.04);
        border-color: rgba(0, 0, 0, 0.06);
    }

    .chats-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    /* ============================================
       SIDEBAR TOGGLE V10.1
    ============================================ */
    .sidebar-toggle {
        position: fixed;
        top: 50%;
        left: 8px;
        transform: translateY(-50%);
        z-index: 140;
        background: rgba(0, 0, 0, 0.5);
        border: none;
        border-radius: 10px;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        backdrop-filter: blur(10px);
        transition: all 0.3s var(--transition-smooth);
        border: 1.5px solid rgba(255, 255, 255, 0.1);
    }
    /* Floating new chat button - appears when sidebar is hidden */
    .floating-new-chat {
        position: fixed;
        left: 64px;
        top: calc(50% + 48px);
        z-index: 130;
        padding: 8px 12px;
        border-radius: 10px;
        background: linear-gradient(135deg,#667eea,#764ba2);
        color: white;
        border: none;
        box-shadow: 0 8px 25px rgba(0,0,0,0.35);
        display: none; /* hidden by default, toggled by JS */
        cursor: pointer;
    }

    .floating-new-chat:hover { opacity: 0.95; }

    @media (max-width: 768px) {
        .floating-new-chat { left: 56px; top: 72px; }
    }

    .sidebar-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: scale(1.05);
    }

    .sidebar-toggle:focus {
        outline: 2px solid rgba(100, 150, 255, 0.85);
        box-shadow: 0 6px 18px rgba(100, 150, 255, 0.24);
    }

    .floating-new-chat:focus {
        outline: 2px solid rgba(102, 126, 234, 0.9);
        box-shadow: 0 8px 30px rgba(102, 126, 234, 0.14);
    }

    .light-mode .sidebar-toggle {
        background: rgba(255, 255, 255, 0.7);
        color: #333;
        border: 1.5px solid rgba(0, 0, 0, 0.08);
    }

    /* ============================================
       MAIN CONTENT V10.1
    ============================================ */
    .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        text-align: center;
        padding: 0;
        position: relative;
        overflow: visible;
        width: 100%;
    }

    /* If sidebar collapsed, make main area slightly shift so content doesn't look cramped */
    body.sidebar-collapsed .main {
        padding-left: 8px;
    }

    .main.chat-mode {
        justify-content: flex-start;
        padding-bottom: 2rem;
        display: flex;
        flex-direction: column;
        align-items: stretch;
    }

    .main.empty-state {
        justify-content: center;
        padding: 40px 24px;
        min-height: 70vh;
    }

    /* Welcome animations */
    .main.empty-state .title {
        animation: fadeInUp 0.6s ease-out;
    }

    .main.empty-state .search-box {
        animation: slideUpFade 0.6s ease-out 0.1s both;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideUpFade {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ============================================
       TITLE V10.1 ENHANCEMENT
    ============================================ */
    .title {
        font-size: 48px;
        font-weight: 700;
        margin-bottom: 48px;
        background: linear-gradient(135deg, 
            #64C8FF 0%, 
            #7EE0FF 30%, 
            #FF6E7F 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        position: relative;
        animation: gradientShift 8s ease infinite;
        background-size: 200% 200%;
        z-index: 10;
        padding-top: 40px;
    }

    @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    .light-mode .title {
        background: linear-gradient(135deg, 
            #0066CC 0%, 
            #0099FF 30%, 
            #8B5CF6 100%);
        -webkit-background-clip: text;
        background-clip: text;
    }

    .title.hidden {
        display: none;
    }

    /* ============================================
       SEARCH BOX V10.1
    ============================================ */
    .search-box {
        width: 100%;
        max-width: 700px;
        background: rgba(30, 30, 30, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        padding: 20px 28px;
        border: 1.5px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s var(--transition-smooth);
        z-index: 10;
        position: relative;
        margin-top: 20px;
        box-shadow: var(--shadow-lg);
    }

    .search-box:focus-within {
        border-color: rgba(100, 200, 255, 0.6);
        box-shadow: 
            0 8px 40px rgba(100, 200, 255, 0.15),
            inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
    }

    .search-box.compact {
        position: fixed;
        top: 1rem;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        max-width: 800px;
        margin: 0;
        background: rgba(30, 30, 30, 0.9);
    }

    .light-mode .search-box {
        background: rgba(255, 255, 255, 0.9);
        border: 1.5px solid rgba(0, 0, 0, 0.08);
    }

    .light-mode .search-box:focus-within {
        border-color: rgba(100, 150, 255, 0.6);
        box-shadow: 
            0 8px 40px rgba(100, 150, 255, 0.12),
            inset 0 0 0 1px rgba(255, 255, 255, 0.3);
    }

    .search-box input {
        flex: 1;
        background: transparent;
        outline: none;
        border: none;
        color: #fff;
        font-size: 16px;
    }

    .light-mode .search-box input {
        color: #333;
    }

    .icons {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 20px;
        cursor: pointer;
    }

    .icons div:hover {
        opacity: 0.8;
    }

    /* ============================================
       CHAT CONTAINER V10.1
    ============================================ */
    .chat-container {
        width: 100%;
        max-width: var(--chat-max-width);
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        overflow-x: hidden;
        padding: 120px 24px 180px;
        z-index: 120;
        margin: 0 auto;
        flex: 1;
        position: relative;
    }

    .chat-container::-webkit-scrollbar {
        width: 10px;
    }

    .chat-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
    }

    .chat-container::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, 
            rgba(100, 200, 255, 0.4) 0%, 
            rgba(100, 150, 255, 0.4) 100%);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: padding-box;
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, 
            rgba(100, 200, 255, 0.6) 0%, 
            rgba(100, 150, 255, 0.6) 100%);
    }

    .light-mode .chat-container::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
    }

    .light-mode .chat-container::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
    }

    /* ============================================
       MESSAGE WRAPPER V10.1
    ============================================ */
    .message-wrapper {
        display: flex;
        margin-bottom: 28px;
        gap: 1rem;
        animation: messageSlideIn 0.4s var(--transition-smooth) forwards;
        width: 100%;
        min-height: 40px;
        align-items: flex-start;
        opacity: 0;
    }

    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-wrapper.user {
        justify-content: flex-end;
        padding-right: 1rem;
    }

    .message-wrapper.assistant {
        justify-content: flex-start;
        padding-left: 1rem;
    }

    /* ============================================
       AVATAR V10.1 ENHANCEMENT
    ============================================ */
    .message-avatar {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
        margin-top: 4px;
        box-shadow: var(--shadow-sm);
        border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .message-wrapper.user .message-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        order: 2;
    }

    .message-wrapper.assistant .message-avatar {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    /* ============================================
       MESSAGE CONTENT V10.1
    ============================================ */
    .message-content {
        max-width: 80%;
        word-wrap: break-word;
        line-height: 1.6;
        display: flex;
        flex-direction: column;
        width: auto;
    }

    @media (max-width: 768px) {
        .message-content {
            max-width: 85%;
        }
    }

    .message-text {
        padding: 22px 28px;
        border-radius: var(--radius-lg);
        font-size: 16px;
        line-height: 1.7;
        background: rgba(0, 0, 0, 0.44);
        color: #e6e6e6;
        backdrop-filter: blur(10px);
        word-wrap: break-word;
        white-space: pre-wrap;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .light-mode .message-text {
        background: rgba(0, 0, 0, 0.08);
        color: #333;
    }

    .message-wrapper.user .message-text {
        background: linear-gradient(135deg, 
            rgba(102, 126, 234, 0.9) 0%, 
            rgba(118, 75, 162, 0.9) 100%);
        color: #ffffff;
        border-bottom-right-radius: var(--radius-sm);
        border-top-right-radius: var(--radius-lg);
        border-top-left-radius: var(--radius-lg);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .message-wrapper.assistant .message-text {
        background: rgba(255, 255, 255, 0.05);
        color: #e6e6e6;
        border-bottom-left-radius: var(--radius-sm);
        border-top-left-radius: var(--radius-lg);
        border-top-right-radius: var(--radius-lg);
        border-left: 4px solid rgba(100, 200, 255, 0.6);
    }

    .light-mode .message-wrapper.assistant .message-text {
        background: rgba(0, 0, 0, 0.03);
        color: #333;
        border-left: 4px solid rgba(100, 150, 255, 0.6);
    }

    /* Message formatting */
    .message-text strong {
        color: #64c8ff;
        font-weight: 600;
    }

    .light-mode .message-text strong {
        color: #0066cc;
    }

    .message-text em {
        color: rgba(255, 255, 255, 0.8);
        font-style: italic;
    }

    .message-actions {
        position: absolute;
        top: 8px;
        right: 10px;
        display: flex;
        gap: 6px;
        z-index: 6;
    }

    .message-actions button {
        background: transparent;
        border: none;
        color: rgba(255,255,255,0.6);
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        font-size: 12px;
    }

    .message-actions button:hover {
        background: rgba(255,255,255,0.04);
        color: rgba(255,255,255,0.95);
    }

    .message-text code {
        background: rgba(0, 0, 0, 0.4);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        color: #64c8ff;
    }

    .message-text ul, .message-text ol {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
    }

    .message-text li {
        margin: 0.25rem 0;
    }

    /* Ensure inline images inside message content are constrained and don't overlap */
    .message-content img {
        display: block;
        max-width: 100%;
        height: auto;
        border-radius: 12px;
        margin-top: 8px;
        box-shadow: var(--shadow-sm);
    }

    /* Sources and metadata */
    .message-metadata {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.5);
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .light-mode .message-metadata {
        color: rgba(0, 0, 0, 0.5);
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .metadata-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* Confidence badge */
    .confidence-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        background: rgba(100, 200, 100, 0.3);
        color: #64c864;
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }

    /* ============================================
       TYPING INDICATOR V10.1
    ============================================ */
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 24px 28px;
    }

    .typing-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        animation: typingBounce 1.8s infinite;
    }

    @keyframes typingBounce {
        0%, 60%, 100% {
            transform: translateY(0) scale(1);
            opacity: 0.4;
        }
        30% {
            transform: translateY(-12px) scale(1.2);
            opacity: 1;
        }
    }

    .light-mode .typing-dot {
        background: rgba(0, 0, 0, 0.6);
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    /* ============================================
       3D CANVAS V10.1 ENHANCEMENT
    ============================================ */
    #container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
        opacity: 0.5;
        filter: blur(1px);
        transition: opacity 0.5s var(--transition-smooth);
    }

    body.light-mode #container {
        opacity: 0.3;
        filter: blur(2px);
    }

    #container:hover {
        opacity: 0.7;
        filter: blur(0px);
    }

    /* ============================================
       COLOR CONTROLS V10.1
    ============================================ */
    .color-controls {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 160;
        pointer-events: auto;
        background: rgba(26, 26, 26, 0.95);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: var(--radius-lg);
        padding: 24px;
        border: 1.5px solid rgba(255, 255, 255, 0.1);
        box-shadow: 
            0 20px 60px rgba(0, 0, 0, 0.4),
            0 0 0 1px rgba(255, 255, 255, 0.05);
        transition: transform 0.28s var(--transition-smooth), 
                    opacity 0.28s var(--transition-smooth);
        transform: translateX(120%);
        opacity: 0;
        pointer-events: none;
    }

    .color-controls.collapsed {
        transform: translateX(120%);
        opacity: 0;
        pointer-events: none;
    }

    .color-controls:not(.collapsed) {
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
    }

    /* Color controls toggle */
    .color-controls-toggle {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 161;
        pointer-events: auto;
        width: 52px;
        height: 52px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background: rgba(0,0,0,0.45);
        color: #fff;
        border: 1.5px solid rgba(255,255,255,0.1);
        box-shadow: 0 6px 18px rgba(0,0,0,0.25);
        transition: all 0.3s var(--transition-smooth);
    }

    .color-controls-toggle.open {
        transform: scale(1.05) rotate(8deg);
        background: linear-gradient(135deg,#667eea,#764ba2);
        color: #fff;
    }

    .color-controls-toggle:hover {
        background: rgba(100, 200, 255, 0.2);
        z-index: 162;
        transform: scale(1.05);
    }

    .light-mode .color-controls-toggle {
        background: rgba(255,255,255,0.85);
        color: #222;
        border: 1.5px solid rgba(0,0,0,0.08);
    }

    .light-mode .color-controls {
        background: rgba(255, 255, 255, 0.95);
        border: 1.5px solid rgba(0, 0, 0, 0.08);
    }

    /* Color scheme grid */
    .color-scheme {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 1.5rem;
    }

    .color-scheme button {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1.5px solid rgba(255, 255, 255, 0.08);
        padding: 16px;
        color: white;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.25s var(--transition-smooth);
        font-size: 0.9rem;
        min-width: 120px;
    }

    .color-scheme button:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .color-scheme button.active {
        background: rgba(100, 200, 255, 0.15);
        border-color: rgba(100, 200, 255, 0.4);
        box-shadow: 
            0 8px 20px rgba(100, 200, 255, 0.2),
            inset 0 0 0 1px rgba(255, 255, 255, 0.1);
    }

    .light-mode .color-scheme button {
        background: rgba(0, 0, 0, 0.05);
        border: 1.5px solid rgba(0, 0, 0, 0.1);
        color: #333;
    }

    .light-mode .color-scheme button:hover {
        background: rgba(0, 0, 0, 0.1);
    }

    .light-mode .color-scheme button.active {
        background: rgba(100, 150, 255, 0.15);
        border-color: rgba(100, 150, 255, 0.4);
    }

    .color-preview {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .light-mode .color-preview {
        border: 2px solid rgba(0, 0, 0, 0.2);
    }

    .color-preview.cosmic {
        background: linear-gradient(45deg, #ff6e7f, #bfe9ff);
    }

    .color-preview.neon {
        background: linear-gradient(45deg, #00ff87, #60efff);
    }

    .color-preview.sunset {
        background: linear-gradient(45deg, #ff8c37, #ff427a);
    }

    .color-preview.ocean {
        background: linear-gradient(45deg, #0082c8, #00b4db);
    }

    /* ============================================
       THEME TOGGLE V10.1
    ============================================ */
    .theme-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 1.5rem 0;
    }

    .switch {
        display: inline-block;
        position: relative;
        width: 80px;
        height: 44px;
    }

    .switch input {
        display: none;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background: linear-gradient(135deg, 
            rgba(100, 200, 255, 0.2) 0%, 
            rgba(100, 150, 255, 0.2) 100%);
        border-radius: 999px;
        border: 1.5px solid rgba(255, 255, 255, 0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 10px;
        transition: background 0.25s ease, border-color 0.25s ease;
    }

    .slider .icon { 
        font-size: 16px; 
        pointer-events: none;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .switch .slider::after {
        content: '';
        position: absolute;
        width: 36px;
        height: 36px;
        left: 3px;
        top: 3px;
        background: linear-gradient(135deg, #64c8ff 0%, #7ee0ff 100%);
        border-radius: 50%;
        box-shadow: 
            0 4px 15px rgba(100, 200, 255, 0.4),
            0 0 0 2px rgba(255, 255, 255, 0.1);
        transition: transform 0.25s var(--transition-smooth), 
                    background 0.25s var(--transition-smooth);
    }

    .switch input:checked + .slider {
        background: rgba(0,0,0,0.08);
        border-color: rgba(0,0,0,0.12);
    }

    .switch input:checked + .slider::after {
        transform: translateX(36px);
        background: #111;
    }

    .light-mode .switch .slider {
        background: rgba(0,0,0,0.04);
        border: 1px solid rgba(0,0,0,0.08);
    }

    .light-mode .switch input:checked + .slider::after {
        background: #fff;
    }

    /* ============================================
       PANEL CONTROLS V10.1
    ============================================ */
    .panel-controls {
        margin-top: 0.75rem;
        display: flex;
        gap: 0.75rem;
        justify-content: center;
    }

    .panel-controls button {
        background: rgba(255,255,255,0.06);
        border: 1.5px solid rgba(255,255,255,0.12);
        color: #fff;
        padding: 12px 20px;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.25s var(--transition-smooth);
    }

    .panel-controls button:hover {
        background: rgba(255,255,255,0.12);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }

    .light-mode .panel-controls button {
        background: rgba(0,0,0,0.04);
        border: 1.5px solid rgba(0,0,0,0.08);
        color: #333;
    }

    .light-mode .panel-controls button:hover {
        background: rgba(0,0,0,0.1);
    }

    /* ============================================
       FOOTER V10.1
    ============================================ */
    .footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, 
            transparent 0%, 
            rgba(26, 26, 26, 0.8) 100%);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        padding: 24px;
        text-align: center;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        transition: all 0.3s var(--transition-smooth);
        z-index: 12;
    }

    .light-mode .footer {
        background: linear-gradient(180deg, 
            transparent 0%, 
            rgba(255, 255, 255, 0.8) 100%);
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        color: rgba(0, 0, 0, 0.6);
    }

    .footer a {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: all 0.3s var(--transition-smooth);
        font-weight: 500;
        position: relative;
        padding-bottom: 2px;
    }

    .footer a::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 2px;
        background: linear-gradient(90deg, #64c8ff, #7ee0ff);
        transition: width 0.3s var(--transition-smooth);
    }

    .footer a:hover::after {
        width: 100%;
    }

    .light-mode .footer a {
        color: rgba(0, 0, 0, 0.8);
    }

    .footer a:hover {
        color: rgba(255, 255, 255, 1);
    }

    .light-mode .footer a:hover {
        color: rgba(0, 0, 0, 1);
    }

    .footer-divider {
        margin: 0 0.5rem;
        opacity: 0.4;
    }

    /* ============================================
       INPUT CONTAINER V10.1
    ============================================ */
    .input-container {
        position: fixed;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 40px);
        left: 50%;
        transform: translateX(-50%);
        z-index: 140;
        width: 90%;
        max-width: 700px;
        padding: 0 1rem;
        display: flex;
        gap: 0.75rem;
        align-items: center;
        background: rgba(30, 30, 30, 0.9);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: var(--radius-lg);
        padding: 16px 24px;
        border: 1.5px solid rgba(255, 255, 255, 0.1);
        box-shadow: 
            0 20px 60px rgba(0, 0, 0, 0.4),
            0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    .input-container input {
        flex: 1;
        padding: 18px 24px;
        border: 1.5px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        border-radius: var(--radius-md);
        color: #fff;
        font-size: 17px;
        backdrop-filter: blur(10px);
        transition: all 0.25s var(--transition-smooth);
        outline: none;
    }

    .input-container input:focus {
        border-color: rgba(100, 200, 255, 0.6);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 0 4px rgba(100, 200, 255, 0.1);
    }

    .input-container input::placeholder {
        color: rgba(255, 255, 255, 0.4);
    }

    .light-mode .input-container {
        background: rgba(255, 255, 255, 0.95);
        border: 1.5px solid rgba(0, 0, 0, 0.08);
        box-shadow: 
            0 20px 60px rgba(0, 0, 0, 0.1),
            0 0 0 1px rgba(255, 255, 255, 0.8);
    }

    .light-mode .input-container input {
        background: rgba(255, 255, 255, 0.9);
        border-color: rgba(0, 0, 0, 0.1);
        color: #333;
    }

    .light-mode .input-container input::placeholder {
        color: rgba(0, 0, 0, 0.4);
    }

    .light-mode .input-container input:focus {
        border-color: rgba(100, 150, 255, 0.6);
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 0 0 4px rgba(100, 150, 255, 0.2);
    }

    /* Input buttons */
    .input-icons {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .input-icons div,
    .input-icons button {
        width: 52px;
        height: 52px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        border-radius: var(--radius-md);
        transition: all 0.25s var(--transition-smooth);
        background: rgba(100, 200, 255, 0.12);
        border: 1.5px solid rgba(255,255,255,0.1);
        padding: 4px;
        box-sizing: border-box;
        color: #64c8ff;
        overflow: visible;
        position: relative;
    }

    .input-icons div:hover,
    .input-icons button:hover {
        background: rgba(100, 200, 255, 0.2);
        border-color: rgba(100, 200, 255, 0.4);
        transform: translateY(-3px) scale(1.05);
        box-shadow: 
            0 12px 30px rgba(100, 200, 255, 0.3),
            inset 0 0 0 1px rgba(255, 255, 255, 0.2);
    }

    .light-mode .input-icons div,
    .light-mode .input-icons button {
        background: rgba(100, 150, 255, 0.06);
    }

    .light-mode .input-icons div:hover,
    .light-mode .input-icons button:hover {
        background: rgba(100, 150, 255, 0.14);
    }

    /* SVG icon sizing */
    .input-icons svg {
        width: 22px;
        height: 22px;
        display: block;
        max-width: 100%;
        max-height: 100%;
        fill: currentColor;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    /* Microphone listening state */
    #voiceBtn.listening {
        background: rgba(100, 200, 255, 0.3);
        animation: pulse-mic 0.6s infinite;
    }

    @keyframes pulse-mic {
        0% {
            box-shadow: 0 0 0 0 rgba(100, 200, 255, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(100, 200, 255, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(100, 200, 255, 0);
        }
    }

    /* ============================================
       VERSION BADGE V10.1
    ============================================ */
    .version-badge {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #64c8ff, #7ee0ff);
        color: #000;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.5px;
        z-index: 1000;
        opacity: 0.7;
        transition: opacity 0.3s var(--transition-smooth);
        pointer-events: none;
    }

    .version-badge:hover {
        opacity: 1;
    }

    /* ============================================
       AUTH MODAL V10.1 ENHANCEMENTS
    ============================================ */
    .auth-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
    }

    .auth-modal-backdrop.open {
        display: flex;
    }

    .auth-modal {
        width: 360px;
        max-width: calc(100% - 32px);
        background: linear-gradient(180deg, rgba(18,18,18,0.96), rgba(28,28,28,0.98));
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow-lg);
        color: #fff;
        z-index: 210;
        transform: translateY(-10px);
        transition: transform 0.18s var(--transition-smooth), 
                    opacity 0.18s var(--transition-smooth);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        border: 1.5px solid rgba(255, 255, 255, 0.1);
    }

    .auth-modal h3 {
        margin-bottom: 16px;
        font-size: 20px;
        color: #e6eef8;
        font-weight: 600;
    }

    .auth-modal .fields { 
        display: flex; 
        flex-direction: column; 
        gap: 12px; 
        margin-top: 12px; 
    }

    .auth-modal input[type="text"], 
    .auth-modal input[type="email"], 
    .auth-modal input[type="password"] {
        width: 100%;
        padding: 14px 16px;
        border-radius: var(--radius-md);
        border: 1.5px solid rgba(255,255,255,0.1);
        background: rgba(0,0,0,0.25);
        color: #fff;
        outline: none;
        transition: all 0.25s var(--transition-smooth);
        font-size: 15px;
    }

    .auth-modal input:focus {
        border-color: rgba(100, 200, 255, 0.6);
        box-shadow: 0 0 0 3px rgba(100, 200, 255, 0.1);
    }

    .auth-modal .actions { 
        display:flex; 
        gap:12px; 
        margin-top:20px; 
    }
    
    .auth-modal .actions button { 
        flex:1; 
        padding:14px 16px; 
        border-radius:var(--radius-md); 
        border:none; 
        cursor:pointer; 
        font-weight: 600;
        transition: all 0.25s var(--transition-smooth);
    }

    .auth-modal .actions .primary { 
        background: linear-gradient(135deg,#64c8ff,#7ee0ff); 
        color:#033; 
        font-weight:600; 
    }
    
    .auth-modal .actions .secondary { 
        background: rgba(255,255,255,0.06); 
        color:#fff; 
    }

    .auth-modal .actions button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }

    .auth-modal .close-btn { 
        position:absolute; 
        top:12px; 
        right:12px; 
        background:transparent; 
        border:none; 
        color:rgba(255,255,255,0.7); 
        font-size:20px; 
        cursor:pointer; 
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.25s var(--transition-smooth);
    }

    .auth-modal .close-btn:hover {
        background: rgba(255,255,255,0.1);
        color: #fff;
    }

    .auth-modal .google-btn { 
        background: linear-gradient(90deg,#fff,#f0f4ff); 
        color:#111; 
        border-radius:var(--radius-md); 
        padding:14px; 
        text-align:center; 
        cursor:pointer; 
        margin-top: 16px;
        font-weight: 600;
        transition: all 0.25s var(--transition-smooth);
    }

    .auth-modal .google-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }

    /* AUTH header controls */
    .auth-btn {
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:8px 12px;
        border-radius:12px;
        background: linear-gradient(90deg,#06b6d4,#3b82f6);
        color:#fff;
        border:none;
        cursor:pointer;
        font-weight:700;
        box-shadow: 0 6px 18px rgba(3,7,33,0.18);
        transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }
    .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(3,7,33,0.24); }
    .auth-btn .icon { width:18px; height:18px; display:inline-block; }

    .auth-avatar { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:50%; background: linear-gradient(90deg,#7c3aed,#06b6d4); color:#fff; font-weight:700; box-shadow: 0 6px 18px rgba(3,7,33,0.18); }
    .auth-logout-btn { background: rgba(255,255,255,0.06); color:#fff; padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); cursor:pointer; font-weight:600; }

    /* ============================================
       FULLSCREEN RESULT V10.1
    ============================================ */
    .fs-result-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 300;
        padding: 5px;
        backdrop-filter: blur(4px);
    }
    
    .fs-result-backdrop.open { 
        display: flex; 
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .fs-result {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(18,18,18,0.99) 0%, rgba(28,28,28,0.99) 100%);
        border-radius: var(--radius-lg);
        padding: 40px;
        box-shadow: var(--shadow-lg);
        overflow-y: auto;
        color: #fff;
        position: relative;
        border: 1.5px solid rgba(255,255,255,0.1);
        display: flex;
        flex-direction: column;
        animation: slideUp 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
    }

    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(40px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fs-result-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 30px;
        padding-bottom: 24px;
        border-bottom: 2px solid rgba(100,200,255,0.2);
    }

    .fs-result-title-group {
        flex: 1;
    }

    .fs-result h2 { 
        margin: 0 0 8px 0; 
        font-size: 32px;
        font-weight: 700;
        line-height: 1.2;
        color: #fff;
        text-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }

    .fs-result .meta { 
        color: rgba(100,200,255,0.8);
        font-size: 13px;
        margin: 0;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }

    .fs-result .meta-item {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 6px 12px;
        background: rgba(100,200,255,0.1);
        border-radius: var(--radius-sm);
        font-size: 12px;
        border: 1px solid rgba(100,200,255,0.2);
    }

    .fs-result .close { 
        position: relative;
        background: rgba(255,255,255,0.1);
        border: 1.5px solid rgba(255,255,255,0.2);
        border-radius: var(--radius-md);
        color: rgba(255,255,255,0.8);
        font-size: 20px;
        cursor: pointer;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s var(--transition-smooth);
        flex-shrink: 0;
    }

    .fs-result .close:hover {
        background: rgba(255,100,100,0.2);
        border-color: rgba(255,100,100,0.4);
        color: #ff6b6b;
        transform: rotate(90deg);
    }

    .fs-result-content {
        flex: 1;
        overflow-y: auto;
        padding-right: 16px;
    }

    .fs-result .snippet { 
        font-size: 16px;
        line-height: 1.8;
        color: rgba(255,255,255,0.88);
        margin-bottom: 28px;
        padding: 24px;
        background: rgba(100,200,255,0.08);
        border-radius: var(--radius-md);
        border-left: 4px solid rgba(100,200,255,0.4);
    }

    .fs-result-section-title {
        font-size: 14px;
        font-weight: 700;
        color: rgba(100,200,255,0.9);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 32px 0 16px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .fs-result .keypoints { 
        margin: 16px 0 32px 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .fs-result .keypoints li { 
        background: linear-gradient(135deg, rgba(100,200,255,0.08) 0%, rgba(100,150,255,0.04) 100%);
        padding: 16px 20px;
        border-radius: var(--radius-md);
        list-style: none;
        border: 1.5px solid rgba(100,200,255,0.15);
        color: rgba(255,255,255,0.9);
        font-size: 14px;
        line-height: 1.6;
        transition: all 0.2s var(--transition-smooth);
    }

    .fs-result .keypoints li:hover {
        background: linear-gradient(135deg, rgba(100,200,255,0.12) 0%, rgba(100,150,255,0.08) 100%);
        border-color: rgba(100,200,255,0.25);
        transform: translateX(4px);
    }

    .fs-result .keypoints li::before {
        content: '✦ ';
        color: rgba(100,200,255,0.7);
        font-weight: 600;
        margin-right: 8px;
    }

    .fs-result .external { 
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid rgba(255,255,255,0.1);
        display: flex;
        gap: 12px;
    }

    .fs-result .external a { 
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #fff;
        background: linear-gradient(135deg, rgba(100,200,255,0.8) 0%, rgba(100,150,255,0.8) 100%);
        text-decoration: none;
        font-weight: 600;
        padding: 12px 24px;
        border-radius: var(--radius-md);
        transition: all 0.2s var(--transition-smooth);
        font-size: 14px;
    }

    .fs-result .external a:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(100,200,255,0.3);
    }

    .fs-result .external a::after {
        content: '↗';
        margin-left: 4px;
    }

    /* Light mode adjustments for fullscreen result */
    .light-mode .fs-result {
        background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(245,245,250,0.98) 100%);
        color: #333;
    }

    .light-mode .fs-result h2 {
        color: #222;
        text-shadow: none;
    }

    .light-mode .fs-result .meta { 
        color: rgba(100,150,255,0.9);
    }

    .light-mode .fs-result .meta-item {
        background: rgba(100,150,255,0.15);
    }

    .light-mode .fs-result .snippet {
        background: rgba(100,150,255,0.08);
        border-left-color: rgba(100,150,255,0.5);
        color: #333;
    }

    .light-mode .fs-result .keypoints li {
        background: linear-gradient(135deg, rgba(100,150,255,0.08) 0%, rgba(100,150,255,0.04) 100%);
        border: 1.5px solid rgba(100,150,255,0.2);
        color: #333;
    }

    .light-mode .fs-result .keypoints li:hover {
        background: linear-gradient(135deg, rgba(100,150,255,0.12) 0%, rgba(100,150,255,0.08) 100%);
    }

    .light-mode .fs-result .close {
        background: rgba(0,0,0,0.05);
        border-color: rgba(0,0,0,0.1);
        color: rgba(0,0,0,0.6);
    }

    .light-mode .fs-result .close:hover {
        background: rgba(255,100,100,0.1);
    }

    /* ============================================
       FULLSCREEN GALLERY V10.1
    ============================================ */
    .fs-gallery-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(6,10,15,0.88);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 301;
        padding: 28px;
        backdrop-filter: blur(4px);
    }
    
    .fs-gallery-backdrop.open { 
        display: flex; 
    }

    .fs-gallery {
        width: 100%;
        max-width: 1200px;
        background: transparent;
        border-radius: var(--radius-lg);
        padding: 24px;
        overflow: auto;
        color: #fff;
        position: relative;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1.5px solid rgba(255,255,255,0.1);
    }

    .fs-gallery .close { 
        position:absolute; 
        top:16px; 
        right:16px; 
        background:transparent; 
        border:none; 
        color:#ddd; 
        font-size:24px; 
        cursor:pointer; 
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.25s var(--transition-smooth);
    }

    .fs-gallery .close:hover {
        background: rgba(255,255,255,0.1);
        color: #fff;
        transform: rotate(90deg);
    }

    .fs-gallery .grid { 
        display:grid; 
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
        gap:24px; 
        margin-top: 20px;
    }
    
    .fs-gallery .card { 
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); 
        border-radius:var(--radius-lg); 
        padding:20px; 
        cursor:pointer; 
        transition: transform 0.25s var(--transition-smooth), 
                    box-shadow 0.25s var(--transition-smooth); 
        border:1.5px solid rgba(255,255,255,0.03); 
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .fs-gallery .card:hover { 
        transform: translateY(-8px); 
        box-shadow: var(--shadow-lg); 
        border-color: rgba(255,255,255,0.1);
    }
    
    .fs-gallery .thumb { 
        width:100%; 
        height:180px; 
        border-radius:var(--radius-md); 
        background-size:cover; 
        background-position:center; 
        margin-bottom:10px; 
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3em;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .fs-gallery .title { 
        font-weight:600; 
        font-size:18px; 
        margin-bottom:8px; 
        color: #fff;
    }
    
    .fs-gallery .card .meta { 
        font-size:13px; 
        color:rgba(255,255,255,0.65); 
        margin-bottom:8px; 
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .fs-gallery .snippet { 
        font-size:14px; 
        color:rgba(255,255,255,0.9); 
        line-height:1.5; 
        max-height:86px; 
        overflow:hidden;
        opacity: 0.8;
    }

    /* ============================================
       FOCUS VISIBLE FOR ACCESSIBILITY
    ============================================ */
    :focus-visible {
        outline: 3px solid rgba(100, 200, 255, 0.6);
        outline-offset: 2px;
        border-radius: var(--radius-sm);
    }

    /* ============================================
       LOADING STATES
    ============================================ */
    button:disabled,
    .input-icons div:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    /* ============================================
       SELECTION STYLING
    ============================================ */
    ::selection {
        background: rgba(100, 200, 255, 0.3);
        color: white;
    }

    /* ============================================
       RESPONSIVE DESIGN V10.1
    ============================================ */
    /* Large tablets and small laptops */
    @media (max-width: 1200px) {
        .sidebar {
            width: 240px;
        }
        
        .search-box {
            width: 80%;
        }
        
        .title {
            font-size: 40px;
        }
    }

    /* Tablets */
    @media (max-width: 992px) {
        .sidebar {
            width: 220px;
            padding: 20px 16px;
        }
        
        .search-box {
            width: 85%;
            padding: 18px 24px;
        }
        
        .title {
            font-size: 36px;
            margin-bottom: 36px;
        }
        
        .color-controls {
            top: 1.5rem;
            right: 1.5rem;
        }
        
        .input-container {
            max-width: 85%;
        }
    }

    /* Small tablets and large phones */
    @media (max-width: 768px) {
        body {
            flex-direction: column;
        }
        
        .sidebar {
            width: 100%;
            height: auto;
            max-height: 60vh;
            position: fixed;
            top: 0;
            left: 0;
            transform: translateY(-100%);
            transition: transform 0.3s var(--transition-smooth);
            z-index: 100;
            border-right: none;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar.active {
            transform: translateY(0);
        }
        
        .sidebar.collapsed {
            transform: translateY(-100%);
        }
        
        .light-mode .sidebar {
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .sidebar-toggle {
            display: flex;
            top: 1rem;
            left: 1rem;
            transform: none;
        }
        
        .main {
            padding: 20px;
            margin-top: 60px;
        }
        
        .title {
            font-size: 32px;
            margin-bottom: 30px;
            padding-top: 20px;
        }
        
        .search-box {
            width: 90%;
            padding: 16px 20px;
        }
        
        .color-controls {
            position: static;
            margin: 1rem auto;
            width: 90%;
            max-width: 300px;
            transform: none !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            position: relative;
            margin-top: 2rem;
        }
        
        .color-controls.collapsed {
            display: none;
        }
        
        .color-controls-toggle {
            display: none;
        }
        
        .chat-container {
            padding: 100px 16px 160px;
            max-width: 100%;
        }
        
        .message-text {
            padding: 18px 20px;
            font-size: 15px;
        }
        
        .input-container {
            width: calc(100% - 32px);
            bottom: 20px;
            margin: 0 16px;
            max-width: 100%;
            padding: 12px 16px;
        }
        
        .input-container input {
            padding: 16px 20px;
            font-size: 16px;
        }
        
        .fs-result {
            padding: 24px;
        }
        
        .fs-result h2 {
            font-size: 24px;
        }
    }

    /* Mobile phones */
    @media (max-width: 576px) {
        .sidebar {
            max-height: 70vh;
            padding: 16px;
        }
        
        .main {
            padding: 16px;
            margin-top: 50px;
        }
        
        .main.empty-state {
            padding: 24px 16px;
        }
        
        .title {
            font-size: 28px;
            margin-bottom: 24px;
        }
        
        .chat-container {
            padding: 80px 12px 140px;
        }

        .message-wrapper {
            margin-bottom: 1.5rem;
            gap: 0.75rem;
        }

        .message-content {
            max-width: 85%;
        }

        .message-text {
            padding: 16px 18px;
            font-size: 14px;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            font-size: 16px;
        }

        .message-metadata {
            font-size: 0.75rem;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .input-container {
            width: calc(100% - 24px);
            bottom: 16px;
            padding: 12px;
            gap: 0.5rem;
        }

        .input-container input {
            padding: 14px 16px;
            font-size: 15px;
        }

        .input-icons {
            gap: 0.4rem;
        }

        .input-icons div,
        .input-container button {
            width: 44px;
            height: 44px;
            font-size: 14px;
        }

        .color-scheme {
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .color-scheme button {
            min-width: 100%;
            padding: 14px;
        }
        
        .panel-controls {
            flex-direction: column;
            gap: 8px;
        }
        
        .panel-controls button {
            width: 100%;
            padding: 14px;
        }
        
        .footer {
            padding: 16px;
            font-size: 0.8rem;
        }
        
        .fs-result {
            padding: 16px;
        }
        
        .fs-result h2 {
            font-size: 20px;
        }
        
        .fs-gallery .grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .fs-gallery .thumb {
            height: 140px;
        }
    }

    /* Very small phones */
    @media (max-width: 400px) {
        .sidebar-toggle {
            top: 0.75rem;
            left: 0.75rem;
            width: 40px;
            height: 40px;
        }
        
        .main {
            margin-top: 40px;
            padding: 12px;
        }
        
        .title {
            font-size: 24px;
            margin-bottom: 20px;
        }

        .chat-container {
            padding: 60px 8px 120px;
        }

        .message-text {
            padding: 14px 16px;
            font-size: 13px;
        }

        .message-metadata {
            font-size: 0.7rem;
        }

        .input-container {
            width: calc(100% - 16px);
            bottom: 12px;
            padding: 10px;
            border-radius: 18px;
        }

        .input-container input {
            padding: 12px 14px;
            font-size: 14px;
            border-radius: 14px;
        }

        .input-icons div,
        .input-container button {
            width: 40px;
            height: 40px;
            font-size: 13px;
        }

        .footer {
            padding: 12px;
            font-size: 0.75rem;
        }
    }

    /* Handle landscape orientation on mobile */
    @media (max-height: 500px) and (orientation: landscape) {
        .sidebar {
            max-height: 80vh;
        }
        
        .main {
            margin-top: 40px;
        }
        
        .title {
            margin-bottom: 20px;
        }
        
        .search-box {
            margin-top: 10px;
        }
        
        .input-container {
            bottom: 16px;
        }
        
        .chat-container {
            padding: 60px 16px 120px;
        }
    }
</style>
</head>

<body>
    <!-- SIDEBAR TOGGLE -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar" aria-controls="sidebar" aria-expanded="true">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <!-- VERSION BADGE -->
    <div class="version-badge">v10.1 • MinzoAI</div>

    <!-- FLOATING NEW CHAT (visible when sidebar is collapsed on larger screens) -->
    <button id="floatingNewChatBtn" class="floating-new-chat" aria-label="New chat" title="New Chat" style="display:none"><span class="nav-icon">➕</span></button>

    <!-- LEFT SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <button id="newChatBtn" class="nav-item" aria-label="New Chat" title="New Chat">
            <span class="nav-icon">➕</span>
            <span class="nav-text">New Chat</span>
        </button>
        <div class="nav-item" aria-label="Search Chats" title="Search Chats">
            <span class="nav-icon">🔍</span>
            <span class="nav-text">Search Chats</span>
        </div>
        <div class="nav-item" aria-label="Library" title="Library">
            <span class="nav-icon">📚</span>
            <span class="nav-text">Library</span>
        </div>

        <h3>Projects</h3>
        <button id="newProjectBtn" class="nav-item" aria-label="New Project">
            <span class="nav-icon">🗂️</span>
            <span class="nav-text">New Project</span>
        </button>
        <div id="projectsList">
            <div class="nav-item project-list-item" data-project-id="demo_proj_1" aria-label="Exam" title="Exam">
                <span class="nav-icon">📁</span>
                <span class="nav-text">Exam</span>
            </div>
        </div>

        <h3>Your Chats</h3>
        <div id="chatsList" class="chats-list">
            <!-- populated dynamically -->
        </div>
    </div>

    <!-- Color Controls Toggle -->
    <button id="colorControlsToggle" class="color-controls-toggle" aria-label="Toggle color controls" title="Toggle color controls">🎨</button>

    <!-- AUTH CONTROLS -->
    <div id="authControls" style="position:fixed;top:1rem;right:1rem;z-index:120;display:flex;gap:0.75rem;align-items:center"></div>

    <!-- Floating Auth Modal -->
    <div id="authModalBackdrop" class="auth-modal-backdrop" aria-hidden="true">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="authModalTitle">
            <button class="close-btn" id="authModalClose" title="Close">✕</button>
            <h3 id="authModalTitle">Sign in</h3>
            <div class="fields">
                <input id="authName" type="text" placeholder="Full name (for sign up)" style="display:none">
                <input id="authEmail" type="email" placeholder="Email">
                <input id="authPassword" type="password" placeholder="Password">
            </div>
            <div class="actions">
                <button id="authSubmit" class="primary">Continue</button>
                <button id="authToggleMode" class="secondary">Switch</button>
            </div>
            <div id="authError" style="margin-top:12px;color:#ffb4b4;font-size:13px;min-height:18px;">&nbsp;</div>
            <div style="margin-top:16px; display:flex; gap:8px; align-items:center;">
                <div style="flex:1; height:1px; background:rgba(255,255,255,0.1)"></div>
                <div style="opacity:0.6; font-size:12px;">or</div>
                <div style="flex:1; height:1px; background:rgba(255,255,255,0.1)"></div>
            </div>
            <div style="margin-top:16px;">
                <div id="authGoogleBtn" class="google-btn">Sign in with Google</div>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModalBackdrop" class="auth-modal-backdrop" aria-hidden="true" style="display:none;">
        <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="projectModalTitle">
            <button class="close-btn" id="projectModalClose" title="Close">✕</button>
            <h3 id="projectModalTitle">Create Project</h3>
            <div class="fields">
                <input id="projectNameInput" type="text" placeholder="Project name">
            </div>
            <div class="actions">
                <button id="createProjectBtn" class="primary">Create</button>
                <button id="cancelProjectBtn" class="secondary">Cancel</button>
            </div>
            <div id="projectError" style="margin-top:12px;color:#ffb4b4;font-size:13px;min-height:18px;">&nbsp;</div>
        </div>
    </div>

    <!-- Fullscreen Result Viewer -->
    <div id="fsResultBackdrop" class="fs-result-backdrop" aria-hidden="true">
        <div class="fs-result" role="dialog" aria-modal="true">
            <div class="fs-result-header">
                <div class="fs-result-title-group">
                    <h2 id="fsResultTitle">Result Title</h2>
                    <div class="meta" id="fsResultMeta">
                        <span class="meta-item">📚 <span id="fsResultSource">Source</span></span>
                        <span class="meta-item">⭐ <span id="fsResultRelevance">Relevance</span></span>
                    </div>
                </div>
                <button class="close" id="fsResultClose" aria-label="Close result">✕</button>
            </div>
            <div class="fs-result-content">
                <div class="fs-result-section-title">📄 Overview</div>
                <div class="snippet" id="fsResultSnippet">Short snippet...</div>
                
                <div class="fs-result-section-title">✦ Key Points</div>
                <ul class="keypoints" id="fsResultKeypoints"></ul>
                
                <div class="external">
                    <a id="fsResultLink" href="#" target="_blank">View Full Article</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Gallery -->
    <div id="fsGalleryBackdrop" class="fs-gallery-backdrop" aria-hidden="true">
        <div class="fs-gallery" role="dialog" aria-modal="true">
            <button class="close" id="fsGalleryClose" aria-label="Close gallery">✕</button>
            <div class="grid" id="fsGalleryGrid"></div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main empty-state" id="mainContent">
        <div class="title" id="mainTitle">How can I help, Rahul?</div>

        <!-- Search Box (Initial State) -->
        <div class="search-box" id="searchBox">
            <input type="text" id="searchInput" placeholder="Ask anything...">
            <div class="icons">
                <div id="voiceBtnMobile" title="Voice input">🎤</div>
            </div>
        </div>

        <!-- Chat Container (hidden initially) -->
        <div class="chat-container" id="chatContainer"></div>
    </div>

    <!-- INPUT CONTAINER - Bottom Fixed Position -->
    <div class="input-container" id="inputContainer">
        <input type="text" id="chatInput" placeholder="Type your message...">
        <div class="input-icons">
            <div id="voiceBtn" title="Voice input" aria-label="Voice input" role="button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19h2v3h-2z" />
                </svg>
            </div>
            <button id="genImgBtn" title="Generate Image" aria-label="Generate Image" role="button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path d="M12 7a5 5 0 100 10 5 5 0 000-10zm9-2h-3.2l-1.6-2H7.8L6.2 5H3a2 2 0 00-2 2v10a2 2 0 002 2h18a2 2 0 002-2V7a2 2 0 00-2-2zM12 17a5 5 0 110-10 5 5 0 010 10z"/>
                </svg>
            </button>
            <button id="typeBtn" title="Send" aria-label="Send" role="button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path d="M21.7 11.3c-.4-.4-1-.4-1.4 0L18 13.6l-1.3-1.3c-.4-.4-1-.4-1.4 0l-1.6 1.6-3.1-3.1 1.6-1.6c.4-.4.4-1 0-1.4L8.4 6 6.7 4.3C6.3 3.9 5.7 3.9 5.3 4.3L3 6.6c-.4.4-.4 1 0 1.4L4.6 9l3.1 3.1-1.6 1.6c-.4.4-.4 1 0 1.4l1.6 1.6 1.7 1.7c.4.4 1 .4 1.4 0l2.3-2.3 1.6-1.6c.4-.4 1-.4 1.4 0l2.3 2.3c.4.4 1 .4 1.4 0l1.6-1.6c.4-.4.4-1 0-1.4l-1.7-1.7-1.6-1.6 1.7-1.7c.4-.4.4-1 0-1.4z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- COLOR CONTROLS -->
    <div class="color-controls collapsed">
        <div class="color-scheme">
            <button class="active" id="cosmicBtn">
                <div class="color-preview cosmic"></div>
                <span>Cosmic</span>
            </button>
            <button id="neonBtn">
                <div class="color-preview neon"></div>
                <span>Neon</span>
            </button>
            <button id="sunsetBtn">
                <div class="color-preview sunset"></div>
                <span>Sunset</span>
            </button> 
            <button id="oceanBtn">
                <div class="color-preview ocean"></div>
                <span>Ocean</span>
            </button>
        </div>

        <!-- Compact Theme toggle -->
        <div class="theme-toggle" id="themeToggle">
            <label class="switch" title="Toggle Day / Night">
                <input type="checkbox" id="themeSwitch">
                <span class="slider">
                    <span class="icon sun">☀️</span>
                    <span class="icon moon">🌙</span>
                </span>
            </label>
        </div>

        <!-- Panel controls -->
        <div class="panel-controls" id="panelControls">
            <button id="sphereBtn" title="Morph to Sphere">🔵 Sphere</button>
            <button id="resetBtn" title="Reset Particles">🔁 Reset</button>
        </div>
    </div>

    <!-- 3D CANVAS -->
    <div id="container"></div>

    <!-- FOOTER -->
    <footer class="footer">
        <div>
            Developed by <a href="#">Rahul Kumar</a>
            <span class="footer-divider">•</span>
            <a href="#">Sneha Yadav</a>
        </div>
        <div style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.7;">
            © 2025 MinzoAI. All rights reserved. v10.1
        </div>
    </footer>

    <script>
        // Runtime-readable backend URL for local dev or build-time override
        (function(){
            try {
                const meta = document.querySelector('meta[name="minzo-backend"]');
                const metaVal = meta && meta.content && meta.content !== '%REACT_APP_BACKEND_URL%' ? meta.content : null;
                window.MINZO_BACKEND_URL = metaVal || (window.__MINZO_BACKEND_URL__ || 'http://localhost:3001');
            } catch (e) { window.MINZO_BACKEND_URL = window.__MINZO_BACKEND_URL__ || 'http://localhost:3001'; }
        })();
        // ============================================
        // V10.1 ENHANCEMENTS - JavaScript
        // ============================================
        
        // Initialize variables
        let scene, camera, renderer, particles;
        const count = 12000;
        let currentState = 'sphere';
        let currentColorScheme = 'cosmic';
        let isNightMode = true;

        // Chat history and sessions
        const CHAT_STORAGE_KEY = 'minzo_chat_history_v2';
        let chatHistory = {};
        let currentChatId = null;

        // Projects storage
        const PROJECTS_STORAGE_KEY = 'minzo_projects_v2';
        let projects = {};

        // ============================================
        // LOAD/SAVE FUNCTIONS
        // ============================================
        function loadChatHistory() {
            try {
                const raw = localStorage.getItem(CHAT_STORAGE_KEY);
                if (!raw) return;
                chatHistory = JSON.parse(raw) || {};
            } catch (e) {
                console.error('❌ Failed to parse chat history', e);
                chatHistory = {};
            }
        }

        function saveChatHistory() {
            try {
                localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(chatHistory));
            } catch (e) {
                console.error('❌ Failed to save chat history', e);
            }
        }

        function loadProjects() {
            try {
                const raw = localStorage.getItem(PROJECTS_STORAGE_KEY);
                if (!raw) return;
                projects = JSON.parse(raw) || {};
            } catch (e) {
                console.error('❌ Failed to load projects', e);
                projects = {};
            }
        }

        function saveProjects() {
            try {
                localStorage.setItem(PROJECTS_STORAGE_KEY, JSON.stringify(projects));
            } catch (e) {
                console.error('❌ Failed to save projects', e);
            }
        }

        // ============================================
        // CHAT MANAGEMENT
        // ============================================
        function createNewChat(title) {
            const id = 'chat_' + Date.now();
            const createdAt = new Date().toISOString();
            chatHistory[id] = { 
                id, 
                title: title || `Chat ${new Date().toLocaleString()}`, 
                createdAt, 
                messages: [] 
            };
            currentChatId = id;
            saveChatHistory();
            renderChatsList();
            clearChatUI();
            
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.classList.remove('empty-state');
                mainContent.classList.add('chat-mode');
            }
            
            const mainTitle = document.getElementById('mainTitle'); 
            if (mainTitle) mainTitle.classList.add('hidden');
            
            const searchBox = document.getElementById('searchBox');
            if (searchBox) searchBox.style.display = 'none';
        }

        function renderChatsList() {
            const list = document.getElementById('chatsList');
            if (!list) return;
            list.innerHTML = '';
            const ids = Object.keys(chatHistory).sort((a,b) => 
                (chatHistory[b].createdAt || 0) > (chatHistory[a].createdAt || 0) ? 1 : -1
            );
            
            ids.forEach(id => {
                const meta = chatHistory[id];
                const item = document.createElement('div');
                item.className = 'nav-item chat-list-item';
                item.setAttribute('data-chat-id', id);
                item.setAttribute('aria-label', meta.title || 'Chat');
                item.title = meta.title || 'Chat';
                item.innerHTML = `
                    <span class="nav-icon">💬</span>
                    <span class="nav-text">
                        <div style="font-weight:600; margin-bottom: 4px;">${meta.title}</div>
                        <div style="font-size:0.8rem; opacity:0.7">${new Date(meta.createdAt).toLocaleDateString()}</div>
                    </span>
                `;
                item.addEventListener('click', () => openChat(id));
                list.appendChild(item);
            });
        }

        function renderProjectsList() {
            const container = document.getElementById('projectsList');
            if (!container) return;
            
            Array.from(container.querySelectorAll('[data-project-id]')).forEach(n => n.remove());

            const ids = Object.keys(projects).sort((a,b) => 
                (projects[b].createdAt || 0) > (projects[a].createdAt || 0) ? 1 : -1
            );
            
            ids.forEach(id => {
                const meta = projects[id];
                const item = document.createElement('div');
                item.className = 'nav-item project-list-item';
                item.setAttribute('data-project-id', id);
                item.setAttribute('aria-label', meta.title || 'Project');
                item.title = meta.title || 'Project';
                item.innerHTML = `
                    <span class="nav-icon">📁</span>
                    <span class="nav-text">
                        <div style="font-weight:600; margin-bottom: 4px;">${meta.title}</div>
                        <div style="font-size:0.8rem; opacity:0.7">${new Date(meta.createdAt).toLocaleDateString()}</div>
                    </span>
                `;
                item.addEventListener('click', () => openProject(id));
                container.appendChild(item);
            });
        }

        function createNewProject(title) {
            const id = 'proj_' + Date.now();
            const createdAt = new Date().toISOString();
            projects[id] = { 
                id, 
                title: title || `Project ${new Date().toLocaleString()}`, 
                createdAt 
            };
            saveProjects();
            renderProjectsList();
        }

        function openProject(id) {
            const proj = projects[id];
            if (!proj) return;
            createNewChat(proj.title || 'Project Chat');
        }

        function openChat(id) {
            const chat = chatHistory[id];
            if (!chat) return;
            currentChatId = id;
            clearChatUI();
            
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.classList.remove('empty-state');
                mainContent.classList.add('chat-mode');
            }
            
            const mainTitle = document.getElementById('mainTitle'); 
            if (mainTitle) mainTitle.classList.add('hidden');
            
            const searchBox = document.getElementById('searchBox');
            if (searchBox) searchBox.style.display = 'none';
            
            chat.messages.forEach(msg => {
                addMessageToChat(msg.text, msg.sender, msg.metadata || {}, { save: false, id: msg.id });
            });
            
            scrollChatToBottom();
            
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) sidebar.classList.remove('active');
            }
        }

        function clearChatUI() {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) chatContainer.innerHTML = '';
        }

        // ============================================
        // THEME MANAGEMENT
        // ============================================
        function applyTheme(isNight) {
            isNightMode = !!isNight;
            if (isNightMode) {
                document.body.classList.remove('light-mode');
            } else {
                document.body.classList.add('light-mode');
            }

            if (renderer) {
                renderer.setClearColor(isNightMode ? 0x000000 : 0xf5f5f7);
            }

            if (particles && particles.material) {
                particles.material.size = window.innerWidth < 768 ? 
                    (isNightMode ? 0.06 : 0.05) : 
                    (isNightMode ? 0.08 : 0.06);
                particles.material.opacity = isNightMode ? 0.8 : 0.6;
                particles.material.blending = isNightMode ? THREE.AdditiveBlending : THREE.NormalBlending;
                particles.material.needsUpdate = true;

                updateParticleColors();
            }

            updateThemeButtons();
        }

        function setThemeByTime() {
            const hour = new Date().getHours();
            const autoNight = hour < 6 || hour >= 18;
            applyTheme(autoNight);
        }

        function saveThemePreference(pref) {
            try { 
                localStorage.setItem('minzo_theme_v2', pref); 
            } catch (e) {}
        }

        function loadThemePreference() {
            try { 
                return localStorage.getItem('minzo_theme_v2'); 
            } catch (e) { 
                return null; 
            }
        }

        function updateThemeButtons() {
            const themeSwitch = document.getElementById('themeSwitch');
            if (!themeSwitch) return;
            themeSwitch.checked = !!isNightMode;
        }

        // ============================================
        // COLOR CONTROLS MANAGEMENT
        // ============================================
        function saveColorControlsPref(collapsed) {
            try { 
                localStorage.setItem('minzo_color_controls_collapsed_v2', collapsed ? '1' : '0'); 
            } catch (e) {}
        }

        function loadColorControlsPref() {
            try { 
                return localStorage.getItem('minzo_color_controls_collapsed_v2'); 
            } catch (e) { 
                return null; 
            }
        }

        function setColorControlsCollapsed(collapsed) {
            const panel = document.querySelector('.color-controls');
            const toggle = document.getElementById('colorControlsToggle');
            if (!panel || !toggle) return;
            
            if (collapsed) {
                panel.classList.add('collapsed');
                toggle.setAttribute('title', 'Show color controls');
                toggle.setAttribute('aria-expanded', 'false');
                toggle.style.transform = 'scale(0.9)';
                toggle.classList.remove('open');
            } else {
                panel.classList.remove('collapsed');
                toggle.setAttribute('title', 'Hide color controls');
                toggle.setAttribute('aria-expanded', 'true');
                toggle.style.transform = 'scale(1)';
                toggle.classList.add('open');
            }
            saveColorControlsPref(collapsed);
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            // Load theme preference
            const pref = loadThemePreference();
            if (pref === 'light') applyTheme(false);
            else if (pref === 'dark') applyTheme(true);
            else setThemeByTime();

            // Initialize Three.js
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(isNightMode ? 0x000000 : 0xf5f5f7);
            document.getElementById('container').appendChild(renderer.domElement);

            camera.position.z = 25;

            createParticles();
            setupEventListeners();

            // Load and render data
            loadChatHistory();
            loadProjects();
            renderChatsList();
            renderProjectsList();
            
            if (!Object.keys(chatHistory).length) {
                createNewChat('Welcome Chat');
            } else {
                const ids = Object.keys(chatHistory).sort((a,b) => 
                    (chatHistory[b].createdAt || 0) > (chatHistory[a].createdAt || 0) ? 1 : -1
                );
                openChat(ids[0]);
            }

            // Apply saved settings
            updateThemeButtons();
            const ccPref = loadColorControlsPref();
            if (ccPref === '1') setColorControlsCollapsed(true);
            else setColorControlsCollapsed(false);

            animate();
            startMinzoAILoop();

            // Initialize viewport handling
            updateVh();
            window.addEventListener('resize', updateVh);
            window.addEventListener('orientationchange', () => { 
                setTimeout(updateVh, 300); 
            });
        }

        // ============================================
        // 3D PARTICLES
        // ============================================
        function createParticles() {
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(count * 3);
            const colors = new Float32Array(count * 3);

            function sphericalDistribution(i) {
                const phi = Math.acos(-1 + (2 * i) / count);
                const theta = Math.sqrt(count * Math.PI) * phi;
                
                return {
                    x: 8 * Math.cos(theta) * Math.sin(phi),
                    y: 8 * Math.sin(theta) * Math.sin(phi),
                    z: 8 * Math.cos(phi)
                };
            }

            for (let i = 0; i < count; i++) {
                const point = sphericalDistribution(i);
                
                positions[i * 3] = point.x + (Math.random() - 0.5) * 0.5;
                positions[i * 3 + 1] = point.y + (Math.random() - 0.5) * 0.5;
                positions[i * 3 + 2] = point.z + (Math.random() - 0.5) * 0.5;

                const color = new THREE.Color();
                const depth = Math.sqrt(point.x * point.x + point.y * point.y + point.z * point.z) / 8;
                
                applyColorScheme(color, depth);

                colors[i * 3] = color.r;
                colors[i * 3 + 1] = color.g;
                colors[i * 3 + 2] = color.b;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: isNightMode ? 0.08 : 0.06,
                vertexColors: true,
                blending: isNightMode ? THREE.AdditiveBlending : THREE.NormalBlending,
                transparent: true,
                opacity: isNightMode ? 0.8 : 0.6,
                sizeAttenuation: true
            });

            if (particles) scene.remove(particles);
            particles = new THREE.Points(geometry, material);
            particles.rotation.x = 0;
            particles.rotation.y = 0;
            particles.rotation.z = 0;
            scene.add(particles);
        }

        function applyColorScheme(color, depth) {
            switch(currentColorScheme) {
                case 'cosmic':
                    color.setHSL(0.5 + depth * 0.2, 0.7, isNightMode ? (0.4 + depth * 0.3) : (0.2 + depth * 0.2));
                    break;
                case 'neon':
                    color.setHSL(0.3 + depth * 0.3, 0.9, isNightMode ? (0.5 + depth * 0.2) : (0.3 + depth * 0.2));
                    break;
                case 'sunset':
                    color.setHSL(0.05 + depth * 0.1, 0.8, isNightMode ? (0.5 + depth * 0.2) : (0.3 + depth * 0.2));
                    break;
                case 'ocean':
                    color.setHSL(0.6 + depth * 0.1, 0.8, isNightMode ? (0.4 + depth * 0.3) : (0.2 + depth * 0.2));
                    break;
            }
        }

        function setColorScheme(scheme) {
            currentColorScheme = scheme;
            
            // Update active button
            document.querySelectorAll('.color-scheme button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(scheme + 'Btn').classList.add('active');
            
            updateParticleColors();
        }

        function updateParticleColors() {
            const colors = particles.geometry.attributes.color.array;
            const positions = particles.geometry.attributes.position.array;
            
            for (let i = 0; i < count; i++) {
                const depth = Math.sqrt(
                    positions[i * 3] * positions[i * 3] + 
                    positions[i * 3 + 1] * positions[i * 3 + 1] + 
                    positions[i * 3 + 2] * positions[i * 3 + 2]
                ) / 8;
                
                const color = new THREE.Color();
                applyColorScheme(color, depth);
                
                colors[i * 3] = color.r;
                colors[i * 3 + 1] = color.g;
                colors[i * 3 + 2] = color.b;
            }
            
            particles.geometry.attributes.color.needsUpdate = true;
        }

        // ============================================
        // EVENT LISTENERS SETUP
        // ============================================
        function setupEventListeners() {
            // Sidebar toggle
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const floatingNewChatBtn = document.getElementById('floatingNewChatBtn');

            function updateSidebarToggleUI() {
                if (!sidebarToggle || !sidebar) return;
                const isCollapsed = (window.innerWidth <= 768) ? false : sidebar.classList.contains('collapsed');
                sidebarToggle.setAttribute('aria-expanded', String(!isCollapsed));
                sidebarToggle.setAttribute('aria-label', isCollapsed ? 'Expand sidebar' : 'Collapse sidebar');
                sidebarToggle.title = isCollapsed ? 'Expand sidebar' : 'Collapse sidebar';
                if (floatingNewChatBtn) {
                    floatingNewChatBtn.style.display = isCollapsed ? 'block' : 'none';
                }
                // Reflect state on body so layout CSS can adapt (e.g., smaller main padding)
                if (isCollapsed) document.body.classList.add('sidebar-collapsed'); else document.body.classList.remove('sidebar-collapsed');

                // Swap toggle icon
                if (sidebarToggle) {
                    const burgerSvg = `
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 6H21M3 12H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>`;
                    const chevronSvg = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>`;
                    sidebarToggle.innerHTML = isCollapsed ? chevronSvg : burgerSvg;
                }
            }

            if (floatingNewChatBtn) {
                floatingNewChatBtn.addEventListener('click', () => {
                    // Create new chat and ensure sidebar remains collapsed on larger screens
                    createNewChat('New Chat');
                    if (window.innerWidth > 768) {
                        sidebar.classList.add('collapsed');
                        updateSidebarToggleUI();
                    } else {
                        sidebar.classList.remove('active');
                    }
                });
            }

            sidebarToggle.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    sidebar.classList.toggle('active');
                } else {
                    sidebar.classList.toggle('collapsed');
                }
                updateSidebarToggleUI();
            });
            window.addEventListener('resize', updateSidebarToggleUI);
            // initialize state
            updateSidebarToggleUI();

            // Color scheme buttons
            document.getElementById('cosmicBtn').addEventListener('click', () => setColorScheme('cosmic'));
            document.getElementById('neonBtn').addEventListener('click', () => setColorScheme('neon'));
            document.getElementById('sunsetBtn').addEventListener('click', () => setColorScheme('sunset'));
            document.getElementById('oceanBtn').addEventListener('click', () => setColorScheme('ocean'));

            // Theme switch
            const themeSwitch = document.getElementById('themeSwitch');
            if (themeSwitch) {
                themeSwitch.addEventListener('change', () => {
                    const isDark = themeSwitch.checked;
                    applyTheme(isDark);
                    saveThemePreference(isDark ? 'dark' : 'light');
                });
            }

            // Color controls toggle
            const colorToggle = document.getElementById('colorControlsToggle');
            if (colorToggle) {
                colorToggle.addEventListener('click', () => {
                    const panel = document.querySelector('.color-controls');
                    if (!panel) return;
                    const collapsed = panel.classList.toggle('collapsed');
                    setColorControlsCollapsed(collapsed);
                });
                // Keyboard support
                colorToggle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        colorToggle.click();
                    }
                });
            }

            // Control buttons
            document.getElementById('sphereBtn').addEventListener('click', () => morphToSphere());
            document.getElementById('resetBtn').addEventListener('click', () => resetParticles());

            // Project management
            const newProjectBtn = document.getElementById('newProjectBtn');
            const projectModalBackdrop = document.getElementById('projectModalBackdrop');
            const projectModalClose = document.getElementById('projectModalClose');
            const createProjectBtn = document.getElementById('createProjectBtn');
            const cancelProjectBtn = document.getElementById('cancelProjectBtn');
            const projectNameInput = document.getElementById('projectNameInput');

            if (newProjectBtn) {
                newProjectBtn.addEventListener('click', () => {
                    if (projectModalBackdrop) projectModalBackdrop.style.display = 'flex';
                    if (projectNameInput) { 
                        projectNameInput.value = ''; 
                        projectNameInput.focus(); 
                    }
                });
            }

            if (projectModalClose) projectModalClose.addEventListener('click', () => { 
                if (projectModalBackdrop) projectModalBackdrop.style.display = 'none'; 
            });
            
            if (cancelProjectBtn) cancelProjectBtn.addEventListener('click', () => { 
                if (projectModalBackdrop) projectModalBackdrop.style.display = 'none'; 
            });
            
            if (createProjectBtn) createProjectBtn.addEventListener('click', () => {
                const name = projectNameInput ? projectNameInput.value.trim() : '';
                if (!name) {
                    const err = document.getElementById('projectError'); 
                    if (err) err.textContent = 'Please enter a project name';
                    return;
                }
                createNewProject(name);
                if (projectModalBackdrop) projectModalBackdrop.style.display = 'none';
            });

            // Chat input handling
            const chatInput = document.getElementById('chatInput');
            const searchInput = document.getElementById('searchInput');
            const typeBtn = document.getElementById('typeBtn');
            const voiceBtn = document.getElementById('voiceBtn');
            const genImgBtn = document.getElementById('genImgBtn');

            function handleSendMessage(inputElement) {
                const q = inputElement.value.trim();
                if (q) {
                    performSearch(q);
                    inputElement.value = '';
                    inputElement.focus();
                }
            }

            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleSendMessage(chatInput);
                    }
                });
            }

            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleSendMessage(searchInput);
                    }
                });
            }

            if (typeBtn) {
                typeBtn.addEventListener('click', () => {
                    handleSendMessage(chatInput);
                });
            }

            // Voice recognition
            if (voiceBtn) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                let recognition = null;
                let isListening = false;

                if (SpeechRecognition) {
                    recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.interimResults = true;
                    recognition.lang = 'en-US';

                    recognition.onstart = () => {
                        isListening = true;
                        voiceBtn.classList.add('listening');
                    };

                    recognition.onresult = (event) => {
                        let finalTranscript = '';
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript + ' ';
                            }
                        }
                        if (finalTranscript) {
                            chatInput.value = finalTranscript.trim();
                        }
                    };

                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        voiceBtn.classList.remove('listening');
                        isListening = false;
                    };

                    recognition.onend = () => {
                        isListening = false;
                        voiceBtn.classList.remove('listening');
                    };
                }

                voiceBtn.addEventListener('click', () => {
                    if (!recognition) {
                        alert('Speech recognition not supported in this browser.');
                        return;
                    }

                    if (isListening) {
                        recognition.abort();
                        isListening = false;
                        voiceBtn.classList.remove('listening');
                    } else {
                        chatInput.value = '';
                        recognition.start();
                    }
                });
            }

            // Image generation
            if (genImgBtn) {
                genImgBtn.addEventListener('click', async () => {
                    let promptText = chatInput ? chatInput.value.trim() : '';
                    if (!promptText) {
                        promptText = window.prompt('Enter a prompt to generate an image:', 'A cozy cabin under northern lights, photorealistic');
                        if (!promptText) return;
                    }
                    try {
                        genImgBtn.disabled = true;
                        genImgBtn.style.opacity = '0.6';
                        // Simulate image generation (replace with actual API call)
                        setTimeout(() => {
                            addMessageToChat(`Generated image for: "${promptText}"\n\n(Image generation would appear here with backend integration)`, 'assistant');
                            genImgBtn.disabled = false;
                            genImgBtn.style.opacity = '1';
                        }, 1500);
                    } catch (err) {
                        console.error('Image generation error', err);
                        genImgBtn.disabled = false;
                        genImgBtn.style.opacity = '1';
                    }
                });
            }

            // New chat button
            const newChatBtn = document.getElementById('newChatBtn');
            if (newChatBtn) {
                newChatBtn.addEventListener('click', () => {
                    createNewChat('New Chat');
                    if (window.innerWidth <= 768) {
                        const sidebar = document.getElementById('sidebar');
                        if (sidebar) sidebar.classList.remove('active');
                    }
                });
            }

            // Auth controls
            updateAuthUI();
        }

        // ============================================
        // CHAT FUNCTIONS
        // ============================================
        async function performSearch(query) {
            console.log('🔍 Search initiated:', query);
            
            const chatContainer = document.getElementById('chatContainer');
            const mainContent = document.getElementById('mainContent');
            const mainTitle = document.getElementById('mainTitle');
            const searchBox = document.getElementById('searchBox');

            if (!chatContainer || !mainContent || !mainTitle) {
                console.error('❌ Required elements not found');
                return;
            }

            addMessageToChat(query, 'user');
            
            mainContent.classList.remove('empty-state');
            mainContent.classList.add('chat-mode');
            mainTitle.classList.add('hidden');
            if (searchBox) searchBox.style.display = 'none';

            console.log('✅ Chat mode activated');
            addTypingIndicator();

            try {
                const token = localStorage.getItem('minzo_token');
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = 'Bearer ' + token;
                
                const res = await fetch(`${window.MINZO_BACKEND_URL}/api/chat`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ message: query })
                });

                removeTypingIndicator();

                if (!res.ok) {
                    throw new Error(`Server error: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                console.log('✅ Response parsed:', data);
                
                if (data && data.success) {
                    const text = data.response || JSON.stringify(data);
                    const metadata = {
                        confidence: data.confidence,
                        source: data.source,
                        topic: data.topic,
                        learned: data.learned
                    };
                    addMessageToChat(text, 'assistant', metadata);

                    // Handle web results
                    try {
                        if (data.webResults && Array.isArray(data.webResults) && data.webResults.length > 0) {
                            if (data.webResults.length > 1) {
                                showFullScreenGallery(data.webResults);
                            } else {
                                showFullScreenResult(data.webResults[0]);
                            }
                        }
                    } catch (e) { 
                        console.warn('Failed to show full screen result', e); 
                    }
                } else {
                    addMessageToChat(data.error || 'No response from server', 'assistant');
                }
            } catch (err) {
                console.error('❌ Error during search:', err);
                removeTypingIndicator();
                const errorMsg = err.message || 'Unknown error';
                
                if (errorMsg.includes('fetch') || !navigator.onLine) {
                    addMessageToChat('⚠️ Cannot connect to server. Make sure the backend is running on ' + window.MINZO_BACKEND_URL, 'assistant');
                } else {
                    addMessageToChat('❌ Error: ' + errorMsg, 'assistant');
                }
            }

            scrollChatToBottom();
        }

        function addMessageToChat(text, sender, metadata = {}, options = { save: true }) {
            const chatContainer = document.getElementById('chatContainer');
            
                if (!chatContainer) {
                    console.error('❌ Chat container not found!');
                    return;
                }

                // Prevent duplicates: if the last message from the same sender is identical, skip
                try {
                    const lastElement = Array.from(chatContainer.querySelectorAll('.message-wrapper.' + sender + ' .message-text')).slice(-1)[0];
                    if (lastElement && String(lastElement.textContent).trim() === String(text).trim()) {
                        console.debug('Duplicate message detected; skipping addMessageToChat');
                        return;
                    }
                } catch (e) {
                    // ignore any query issues and continue
                }

            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message-wrapper ${sender}`;
            // add a unique message id (reuse if provided via options.id)
            const messageId = (options && options.id) ? options.id : ('msg_' + Date.now() + '_' + Math.floor(Math.random() * 1000000));
            messageWrapper.dataset.msgId = messageId;

            const messageAvatar = document.createElement('div');
            messageAvatar.className = 'message-avatar';
            messageAvatar.textContent = sender === 'user' ? '👤' : '🤖';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.textContent = text;

            messageContent.appendChild(messageText);

            // Add message actions (delete button etc.)
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            const delBtn = document.createElement('button');
            delBtn.className = 'delete-btn';
            delBtn.title = 'Delete this message';
            delBtn.setAttribute('aria-label', 'Delete message');
            delBtn.textContent = '🗑';
            delBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteMessageFromChat(messageId);
            });
            actions.appendChild(delBtn);
            messageContent.appendChild(actions);

            if (sender === 'assistant' && Object.keys(metadata).length > 0) {
                const metadataDiv = document.createElement('div');
                metadataDiv.className = 'message-metadata';

                if (metadata.confidence) {
                    const confItem = document.createElement('div');
                    confItem.className = 'metadata-item';
                    confItem.innerHTML = `<span>🎯 Confidence: ${Math.round(metadata.confidence * 100)}%</span>`;
                    metadataDiv.appendChild(confItem);
                }

                if (metadata.source) {
                    const sourceItem = document.createElement('div');
                    sourceItem.className = 'metadata-item';
                    sourceItem.innerHTML = `<span>📚 Source: ${metadata.source}</span>`;
                    metadataDiv.appendChild(sourceItem);
                }

                if (metadata.topic) {
                    const topicItem = document.createElement('div');
                    topicItem.className = 'metadata-item';
                    topicItem.innerHTML = `<span>🏷️ Topic: ${metadata.topic}</span>`;
                    metadataDiv.appendChild(topicItem);
                }

                if (metadata.learned) {
                    const learnedItem = document.createElement('div');
                    learnedItem.className = 'metadata-item';
                    learnedItem.innerHTML = `<span>✅ Learned & Stored</span>`;
                    metadataDiv.appendChild(learnedItem);
                }

                messageContent.appendChild(metadataDiv);
            }

            messageWrapper.appendChild(messageAvatar);
            messageWrapper.appendChild(messageContent);
            chatContainer.appendChild(messageWrapper);
            
            if (options && options.save !== false) {
                if (!currentChatId) {
                    createNewChat();
                }
                const msgObj = { 
                    id: messageId,
                    sender, 
                    text, 
                    metadata: metadata || {}, 
                    timestamp: new Date().toISOString() 
                };
                if (!chatHistory[currentChatId]) {
                    chatHistory[currentChatId] = { 
                        id: currentChatId, 
                        title: `Chat ${new Date().toLocaleString()}`, 
                        createdAt: new Date().toISOString(), 
                        messages: [] 
                    };
                }
                chatHistory[currentChatId].messages.push(msgObj);
                
                if (!chatHistory[currentChatId].title || chatHistory[currentChatId].title.startsWith('Chat')) {
                    const firstUser = chatHistory[currentChatId].messages.find(m => m.sender === 'user');
                    if (firstUser) {
                        chatHistory[currentChatId].title = firstUser.text.slice(0, 60) + 
                            (firstUser.text.length > 60 ? '…' : '');
                    }
                }
                saveChatHistory();
                renderChatsList();
            }
            
            scrollChatToBottom();
        }

        function addTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper assistant';
            messageWrapper.id = 'typing-indicator';

            const messageAvatar = document.createElement('div');
            messageAvatar.className = 'message-avatar';
            messageAvatar.textContent = '🤖';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';

            messageContent.appendChild(typingIndicator);
            messageWrapper.appendChild(messageAvatar);
            messageWrapper.appendChild(messageContent);
            chatContainer.appendChild(messageWrapper);
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function scrollChatToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                setTimeout(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 100);
            }
        }

        function deleteMessageFromChat(msgId) {
            if (!msgId) return;
            try {
                if (!confirm('Delete this message?')) return;
                if (!currentChatId || !chatHistory[currentChatId]) return;
                const before = chatHistory[currentChatId].messages.length;
                chatHistory[currentChatId].messages = chatHistory[currentChatId].messages.filter(m => m.id !== msgId);
                if (chatHistory[currentChatId].messages.length !== before) {
                    saveChatHistory();
                    // Remove from DOM
                    const el = document.querySelector(`#chatContainer [data-msg-id="${msgId}"]`);
                    if (el && el.parentNode) el.parentNode.removeChild(el);
                    renderChatsList();
                }
            } catch (e) {
                console.error('Failed to delete message', e);
            }
        }

        // ============================================
        // FULLSCREEN VIEWERS
        // ============================================
        function showFullScreenResult(result) {
            try {
                const backdrop = document.getElementById('fsResultBackdrop');
                const title = document.getElementById('fsResultTitle');
                const source = document.getElementById('fsResultSource');
                const relevance = document.getElementById('fsResultRelevance');
                const snippet = document.getElementById('fsResultSnippet');
                const keypoints = document.getElementById('fsResultKeypoints');
                const link = document.getElementById('fsResultLink');
                const close = document.getElementById('fsResultClose');

                if (!backdrop) return;

                title.textContent = result.title || result.heading || result.name || 'Result';
                source.textContent = result.source || 'AI Knowledge Base';
                relevance.textContent = result.relevance ? `${Math.round(result.relevance * 100)}%` : '85%';
                snippet.textContent = result.snippet || (result.content && result.content.substring(0, 500)) || 'No description available.';

                keypoints.innerHTML = '';
                const points = result.keyPoints || result.keypoints || [];
                if (points.length === 0) {
                    const text = result.snippet || result.content || '';
                    const sentences = text.split('.').filter(s => s.trim().length > 20).slice(0, 5);
                    sentences.forEach(sentence => {
                        const li = document.createElement('li');
                        li.textContent = sentence.trim() + '.';
                        keypoints.appendChild(li);
                    });
                } else {
                    points.slice(0, 8).forEach(p => {
                        const li = document.createElement('li');
                        li.textContent = p;
                        keypoints.appendChild(li);
                    });
                }

                link.href = result.link || result.url || '#';
                link.textContent = result.link ? 'View Full Article' : (result.url ? 'Open Source' : 'Learn More');

                backdrop.classList.add('open');
                backdrop.setAttribute('aria-hidden', 'false');

                close.onclick = () => closeFullScreenResult();
                backdrop.addEventListener('click', (e) => {
                    if (e.target === backdrop) closeFullScreenResult();
                });
                
                const escapeHandler = (e) => { 
                    if (e.key === 'Escape') closeFullScreenResult(); 
                };
                document.addEventListener('keydown', escapeHandler);
                
                close._escapeHandler = escapeHandler;
            } catch (e) { 
                console.warn('showFullScreenResult error', e); 
            }
        }

        function closeFullScreenResult() {
            const backdrop = document.getElementById('fsResultBackdrop');
            if (!backdrop) return;
            backdrop.classList.remove('open');
            backdrop.setAttribute('aria-hidden', 'true');
            
            const close = document.getElementById('fsResultClose');
            if (close && close._escapeHandler) {
                document.removeEventListener('keydown', close._escapeHandler);
            }
        }

        function showFullScreenGallery(results) {
            if (!Array.isArray(results) || results.length === 0) return;
            const backdrop = document.getElementById('fsGalleryBackdrop');
            if (!backdrop) return;
            const grid = backdrop.querySelector('#fsGalleryGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            results.forEach((result, idx) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';
                card.innerHTML = `
                    <div class="thumb"></div>
                    <div class="title">${(result.title || 'Untitled').substring(0, 50)}</div>
                    <div class="meta">${result.source || 'Unknown'}</div>
                    <div class="snippet">${(result.snippet || '').substring(0, 60)}...</div>
                `;
                card.addEventListener('click', () => {
                    closeFullScreenGallery();
                    showFullScreenResult(result);
                });
                grid.appendChild(card);
            });
            
            backdrop.classList.add('open');
            backdrop.setAttribute('aria-hidden', 'false');
            
            const escapeHandler = (e) => { 
                if (e.key === 'Escape') closeFullScreenGallery(); 
            };
            document.addEventListener('keydown', escapeHandler);
            
            const closeBtn = document.getElementById('fsGalleryClose');
            if (closeBtn) closeBtn._escapeHandler = escapeHandler;
        }

        function closeFullScreenGallery() {
            const backdrop = document.getElementById('fsGalleryBackdrop');
            if (!backdrop) return;
            backdrop.classList.remove('open');
            backdrop.setAttribute('aria-hidden', 'true');
            
            const closeBtn = document.getElementById('fsGalleryClose');
            if (closeBtn && closeBtn._escapeHandler) {
                document.removeEventListener('keydown', closeBtn._escapeHandler);
            }
        }

        // ============================================
        // PARTICLE ANIMATIONS
        // ============================================
        function createTextPoints(text) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const fontSize = 100;
            const padding = 20;

            ctx.font = `bold ${fontSize}px Arial`;
            const textMetrics = ctx.measureText(text);
            const textWidth = textMetrics.width;
            const textHeight = fontSize;

            canvas.width = textWidth + padding * 2;
            canvas.height = textHeight + padding * 2;

            ctx.fillStyle = isNightMode ? 'white' : 'black';
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'center';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            const points = [];
            const threshold = 128;

            for (let i = 0; i < pixels.length; i += 4) {
                if (pixels[i] > threshold) {
                    const x = (i / 4) % canvas.width;
                    const y = Math.floor((i / 4) / canvas.width);
                    
                    if (Math.random() < 0.3) {
                        points.push({
                            x: (x - canvas.width / 2) / (fontSize / 10),
                            y: -(y - canvas.height / 2) / (fontSize / 10)
                        });
                    }
                }
            }

            return points;
        }

        function morphToText(text) {
            currentState = 'text';
            const textPoints = createTextPoints(text);
            const positions = particles.geometry.attributes.position.array;
            const targetPositions = new Float32Array(count * 3);
            const colors = particles.geometry.attributes.color.array;

            gsap.to(particles.rotation, {
                x: 0,
                y: 0,
                z: 0,
                duration: 0.5
            });

            for (let i = 0; i < count; i++) {
                if (i < textPoints.length) {
                    targetPositions[i * 3] = textPoints[i].x;
                    targetPositions[i * 3 + 1] = textPoints[i].y;
                    targetPositions[i * 3 + 2] = 0;
                    if (!isNightMode) {
                        colors[i * 3] = 0.05;
                        colors[i * 3 + 1] = 0.05;
                        colors[i * 3 + 2] = 0.05;
                    }
                } else {
                    const angle = Math.random() * Math.PI * 2;
                    const radius = Math.random() * 20 + 10;
                    targetPositions[i * 3] = Math.cos(angle) * radius;
                    targetPositions[i * 3 + 1] = Math.sin(angle) * radius;
                    targetPositions[i * 3 + 2] = (Math.random() - 0.5) * 10;
                }
            }

            for (let i = 0; i < positions.length; i += 3) {
                gsap.to(particles.geometry.attributes.position.array, {
                    [i]: targetPositions[i],
                    [i + 1]: targetPositions[i + 1],
                    [i + 2]: targetPositions[i + 2],
                    duration: 2,
                    ease: "power2.inOut",
                    onUpdate: () => {
                        particles.geometry.attributes.position.needsUpdate = true;
                        particles.geometry.attributes.color.needsUpdate = true;
                    }
                });
            }
        }

        function morphToSphere() {
            currentState = 'sphere';
            const positions = particles.geometry.attributes.position.array;
            const targetPositions = new Float32Array(count * 3);

            function sphericalDistribution(i) {
                const phi = Math.acos(-1 + (2 * i) / count);
                const theta = Math.sqrt(count * Math.PI) * phi;
                
                return {
                    x: 8 * Math.cos(theta) * Math.sin(phi),
                    y: 8 * Math.sin(theta) * Math.sin(phi),
                    z: 8 * Math.cos(phi)
                };
            }

            for (let i = 0; i < count; i++) {
                const point = sphericalDistribution(i);
                
                targetPositions[i * 3] = point.x + (Math.random() - 0.5) * 0.5;
                targetPositions[i * 3 + 1] = point.y + (Math.random() - 0.5) * 0.5;
                targetPositions[i * 3 + 2] = point.z + (Math.random() - 0.5) * 0.5;
            }

            for (let i = 0; i < positions.length; i += 3) {
                gsap.to(particles.geometry.attributes.position.array, {
                    [i]: targetPositions[i],
                    [i + 1]: targetPositions[i + 1],
                    [i + 2]: targetPositions[i + 2],
                    duration: 2,
                    ease: "power2.inOut",
                    onUpdate: () => {
                        particles.geometry.attributes.position.needsUpdate = true;
                    }
                });
            }
        }

        function resetParticles() {
            createParticles();
            currentState = 'sphere';
        }

        function startMinzoAILoop() {
            setTimeout(() => {
                morphToText('minzoAI');
                
                setInterval(() => {
                    if (currentState === 'sphere') {
                        morphToText('minzoAI');
                        setTimeout(() => {
                            morphToSphere();
                        }, 4000);
                    }
                }, 10000);
            }, 2000);
        }

        // ============================================
        // ANIMATION LOOP
        // ============================================
        function animate() {
            requestAnimationFrame(animate);
            
            if (currentState === 'sphere') {
                particles.rotation.y += 0.002;
            }
            
            renderer.render(scene, camera);
        }

        // ============================================
        // WINDOW RESIZE HANDLER
        // ============================================
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            if (particles && particles.material) {
                particles.material.size = window.innerWidth < 768 ? 
                    (isNightMode ? 0.06 : 0.05) : 
                    (isNightMode ? 0.08 : 0.06);
                particles.material.needsUpdate = true;
            }
        });

        // ============================================
        // VIEWPORT HEIGHT HANDLING
        // ============================================
        function updateVh() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // ============================================
        // AUTH FUNCTIONS (Minimal implementation)
        // ============================================
        function updateAuthUI() {
            const authControls = document.getElementById('authControls');
            if (!authControls) return;
            
            const token = localStorage.getItem('minzo_token');
            authControls.innerHTML = '';
            
            if (token) {
                const user = JSON.parse(localStorage.getItem('minzo_user') || 'null');
                const avatar = document.createElement('div');
                avatar.className = 'auth-avatar';
                const initials = user && (user.name || user.email)
                    ? ((user.name || user.email).split(' ').map(n=>n[0]).slice(0,2).join('').toUpperCase())
                    : 'U';
                avatar.textContent = initials;
                avatar.title = user && user.name ? user.name : (user && user.email ? user.email : 'User');
                authControls.appendChild(avatar);

                const logoutBtn = document.createElement('button');
                logoutBtn.className = 'auth-logout-btn';
                logoutBtn.textContent = 'Logout';
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('minzo_token');
                    localStorage.removeItem('minzo_user');
                    updateAuthUI();
                });
                authControls.appendChild(logoutBtn);
            } else {
                const loginBtn = document.createElement('button');
                loginBtn.className = 'auth-btn';
                loginBtn.innerHTML = `<span class='icon'>
                    <svg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg' width='18' height='18'>
                        <path d='M12 2a10 10 0 100 20 10 10 0 000-20z' fill='rgba(255,255,255,0.12)'></path>
                        <path d='M12.5 7v3h3' stroke='#fff' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path>
                    </svg>
                </span><span>Sign in</span>`;
                loginBtn.addEventListener('click', () => {
                    showAuthModal('login');
                });
                loginBtn.setAttribute('aria-label','Sign in to Minzo');
                authControls.appendChild(loginBtn);
            }
        }

        // ============================================
        // INITIALIZE APPLICATION
        // ============================================
        // AUTH helpers and floating modal (from bak)
        let _authModalInitialized = false;
        function showAuthModal(mode = 'login') {
            const backdrop = document.getElementById('authModalBackdrop');
            const modal = backdrop && backdrop.querySelector('.auth-modal');
            const title = modal && modal.querySelector('h3');
            const nameInput = document.getElementById('authName');
            const emailInput = document.getElementById('authEmail');
            const passInput = document.getElementById('authPassword');
            const submitBtn = document.getElementById('authSubmit');
            const toggleBtn = document.getElementById('authToggleMode');
            const closeBtn = document.getElementById('authModalClose');
            const googleBtn = document.getElementById('authGoogleBtn');

            if (!backdrop || !modal) {
                // fallback to prompt behavior
                const email = prompt('Email:');
                if (!email) return;
                const password = prompt('Password:');
                if (!password) return;
                fetch(`${window.MINZO_BACKEND_URL}/api/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) })
                    .then(r => r.json()).then(d => { if (d && d.success && d.token) { localStorage.setItem('minzo_token', d.token); localStorage.setItem('minzo_user', JSON.stringify(d.user || null)); location.reload(); } else alert('Login failed'); })
                    .catch(() => alert('Login error'));
                return;
            }

            // populate mode UI
            const isRegister = mode === 'register';
            title.textContent = isRegister ? 'Sign up' : 'Sign in';
            nameInput.style.display = isRegister ? 'block' : 'none';
            toggleBtn.textContent = isRegister ? 'Switch to Login' : 'Switch to Sign up';
            submitBtn.textContent = isRegister ? 'Create account' : 'Continue';

            // focus
            emailInput.value = '';
            passInput.value = '';
            nameInput.value = '';
            emailInput.focus();

            // open
            backdrop.classList.add('open');
            backdrop.setAttribute('aria-hidden', 'false');

            if (!_authModalInitialized) {
                _authModalInitialized = true;

                const authErrorDiv = document.getElementById('authError');
                function setAuthError(msg) {
                    if (!authErrorDiv) return;
                    authErrorDiv.textContent = msg || '\u00A0';
                }

                // submit handler
                submitBtn.addEventListener('click', async () => {
                    setAuthError('');
                    const email = emailInput.value && emailInput.value.trim();
                    const password = passInput.value && passInput.value.trim();
                    const name = nameInput.value && nameInput.value.trim();
                    if (!email || !password) { setAuthError('Please provide email and password'); return; }

                    if (title.textContent.toLowerCase().includes('sign up')) {
                        try {
                                const res = await fetch(`${window.MINZO_BACKEND_URL}/api/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password, name: name || email.split('@')[0] }) });
                            const data = await res.json();
                            if (data && data.success && data.token) {
                                localStorage.setItem('minzo_token', data.token);
                                localStorage.setItem('minzo_user', JSON.stringify(data.user || null));
                                backdrop.classList.remove('open');
                                location.reload();
                            } else {
                                setAuthError('Register failed: ' + (data && data.error ? data.error : 'unknown'));
                            }
                        } catch (e) { setAuthError('Register error: ' + (e && e.message ? e.message : 'network')); }
                    } else {
                        try {
                            const res = await fetch(`${window.MINZO_BACKEND_URL}/api/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
                            const data = await res.json();
                            if (data && data.success && data.token) {
                                localStorage.setItem('minzo_token', data.token);
                                localStorage.setItem('minzo_user', JSON.stringify(data.user || null));
                                backdrop.classList.remove('open');
                                location.reload();
                            } else {
                                setAuthError('Login failed: ' + (data && data.error ? data.error : 'unknown'));
                            }
                        } catch (e) { setAuthError('Login error: ' + (e && e.message ? e.message : 'network')); }
                    }
                });

                // toggle mode
                toggleBtn.addEventListener('click', () => {
                    const nowRegister = title.textContent.toLowerCase().includes('sign in');
                    showAuthModal(nowRegister ? 'register' : 'login');
                });

                // google
                googleBtn.addEventListener('click', () => {
                    window.location.href = `${window.MINZO_BACKEND_URL}/auth/google`;
                });

                // close handlers
                closeBtn.addEventListener('click', () => { backdrop.classList.remove('open'); backdrop.setAttribute('aria-hidden', 'true'); setAuthError(''); });
                backdrop.addEventListener('click', (e) => { if (e.target === backdrop) { backdrop.classList.remove('open'); backdrop.setAttribute('aria-hidden', 'true'); setAuthError(''); } });
            }
        }

        // If redirected back with token in URL hash (#token=...), pick it up
        function pickTokenFromHash() {
            if (window.location.hash && window.location.hash.includes('token=')) {
                const m = window.location.hash.match(/token=([^&]+)/);
                if (m && m[1]) {
                    const token = decodeURIComponent(m[1]);
                    localStorage.setItem('minzo_token', token);
                    // optionally fetch /api/me
                    fetch(`${window.MINZO_BACKEND_URL}/api/me`, { headers: { 'Authorization': 'Bearer ' + token } })
                        .then(r => r.json()).then(d => {
                            if (d && d.success && d.user) localStorage.setItem('minzo_user', JSON.stringify(d.user));
                            window.location.hash = '';
                            try { setupSSE(token); } catch (e) {}
                            location.reload();
                        }).catch(() => { window.location.hash = ''; location.reload(); });
                }
            }
        }

        pickTokenFromHash();

        // SSE client for real-time updates
        let _minzoSse = null;
        function setupSSE(token) {
            try {
                if (_minzoSse) {
                    try { _minzoSse.close(); } catch (e) {}
                }
                const url = `${window.MINZO_BACKEND_URL}/api/stream?token=${encodeURIComponent(token)}`;
                _minzoSse = new EventSource(url);
                _minzoSse.addEventListener('interaction', (e) => {
                    try {
                        const interaction = JSON.parse(e.data);
                        const chatContainer = document.getElementById('chatContainer');
                        if (interaction.userInput) {
                            addMessageToChat(interaction.userInput, 'user', {}, { save: true });
                        }
                        if (interaction.aiResponse) {
                            let dup = false;
                            if (chatContainer) {
                                const assistantMessages = Array.from(chatContainer.querySelectorAll('.message-wrapper.assistant .message-text'));
                                if (assistantMessages.length > 0) {
                                    const last = assistantMessages[assistantMessages.length - 1].textContent || '';
                                    if (last.trim() === interaction.aiResponse.trim()) dup = true;
                                }
                            }
                            if (!dup) addMessageToChat(interaction.aiResponse, 'assistant', {}, { save: true });
                        }
                        scrollChatToBottom();
                    } catch (err) {
                        console.error('SSE parse error', err);
                    }
                });
                _minzoSse.onerror = (err) => { console.warn('SSE error', err); };
            } catch (e) {
                console.warn('Failed to setup SSE:', e);
            }
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>